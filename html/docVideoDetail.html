<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--通用样式-->
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../css/icons-extra.css" />
		<link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css" />
		<link rel="stylesheet" href="../css/jinhu.css">
		<link rel="stylesheet" href="../css/bvd.css">

	</head>
	<style>
		.nav {
			display: inline-block;
			/* Firefox */
			display: -moz-box;
			-moz-box-orient: horizontal;
			/* Safari, Opera, and Chrome */
			display: -webkit-box;
			-webkit-box-orient: horizontal;
			/* W3C */
			display: box;
			box-orient: horizontal;
		}
		.bar-item {
			-webkit-box-flex: 1.0;
			-moz-box-flex: 1.0;
			box-flex: 1.0;
			color: #CBCBCB;
		}
		.downloadpop{
			position: fixed;
			text-align: center;
			width: 80%;
			margin-left: 10%;
			margin-right: 10%;
			top: 25%;
			z-index: 999999999;
		}
		#starts{  
		    width:auto !important;  
		}  
		#starts img{
			width: 1.5rem;
			height: 1.5rem;
			margin: 0 5px 0 5px;
		}
		.jh-bar-comment .jh-comment-right a {
			color: #fff;
		}
		.jh-bar-comment .jh-comment-edit{
			border-bottom:1px solid #4e4e4e;
		}
		.jh-bar-comment .jh-comment-edit i{
			color: #E4E4E4;
		}
		.jh-bar-comment {
			border-top: 1px solid #333333;
			background-color: rgba(0, 0, 0, 0.7);
		}
		.mui-bar-nav {
			border-bottom: 1px solid rgba(0, 0, 0, 0.6);
			background-color: rgba(0, 0, 0, 0.6);
		}
		
		.mui-icon-left-nav {
			color: #fff;
		}
		.mui-slider-item img{
			width: 100%;
		}
		.jh-detail-content .mui-content-padded{
			background-color: #000000;
		}
		.jh-dropdown-list i {
		    font-size: 22px;
		    width: 22px;
		}
		.jh-detail-title{
			display: flex;
			display: -webkit-flex;
			/* Safari */
			-webkit-flex-wrap: wrap;
			flex-wrap: wrap
		}
		#reportContainer{
			position: fixed;
			margin-left: 5%;
			min-height: 375px;
			background-color: #ffffff;
		}
		#reportContainer button{
			width: 50%;
		    height: 40px;
		    line-height: 24px;
		    border-right: 1px solid #eff2f9;
		    border-top: none;
		    border-bottom: none;
		    text-align: center;
		    margin-right: 0px;
		}
		#reportContainer p {
			margin-bottom: 0px;
		    height: 40px;
		    line-height: 40px;
		    width: 100%;
		    border-top: 1px solid #eff2f9;
		}
		#reportContainer ul{
			background-color: #fff;
			margin: 5px 5px;
			padding: 3px;
		}
	</style>

	<body style="background-color: #000;">
		<header class="mui-bar mui-bar-nav">
			<button class="mui-action-back mui-btn mui-btn-link mui-btn-nav mui-pull-left" style="color:#333333">
            <span class="mui-icon mui-icon-left-nav"></span><span id="CategoryName"></span>
        </button>
			<a id="documentOpt" class="mui-icon mui-icon-bars mui-pull-right" style="color: #FFF;"></a>
		</header>
		<div id="popover" class="mui-popover" style="position:fixed;width: 130px;height: auto;background-color: #FFFFFF;right: 5px;top: 50px;border-radius:0">
			<ul class="mui-list-unstyled jh-dropdown-list" style="margin-top:0px;border: none;">
				<li id="EssentialOperation" style="height: 30px;line-height: 30px;">

				</li>
				<li id="StickyOperation" style="height: 30px;line-height: 30px;">

				</li>
				<li id="editDoc" style="height: 30px;line-height: 30px;display: none;">
					<a><i class="fa fa-edit" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp编辑</a>
				</li>
				<li id="Deletedocument" style="height: 30px;line-height: 30px;padding-top: 3px;">
					<a><i class="fa fa-trash-o" aria-hidden="true"></i>&nbsp;&nbsp删除</a>
				</li>
				<li id="report" style="height：30px;line-height: 30px;padding-top: 3px;">
					<a><i class="fa fa-exclamation-triangle" aria-hidden="true"></i>&nbsp;&nbsp举报</a>
				</li>
			</ul>
		</div>
		
		<div id="canDownloadPop" class="jh-wenku-popup mui-popover downloadpop">
	        <div class="mui-popup-inner" style="border-radius:13px">
	            <div class="mui-popup-title jh-detail-title" style="text-align: center;word-break: break-all;">
	            	<span>
	            		<span id="pop_title"></span><span id="pop_size"></span>
	            	</span>
	            </div>
	            <p>下载文档，需要支付<span class="tn-red-color tn-font-20" id="pop_price"></span>个<span class="pointName"></span></p>
	            <p>您当前持有<span id="pop_userprice"></span>个<span class="pointName"></span></p>
	            <div class="mui-popup-buttons">
	                <span class="mui-popup-button">
	                    <button class="mui-btn mui-btn-primary" id="confirmDownload">确认下载</button>
	                    <button type="button" class="mui-btn" id="cancelDownload">取消</button>
	                </span>
	            </div>
	        </div>
	    </div>
	    
	    <div id="downloadPop" class="jh-wenku-popup mui-popover downloadpop">
	        <div class="mui-popup-inner" style="border-radius:13px">
	            <div class="mui-popup-title jh-detail-title" style="text-align: center;word-break: break-all;">
	            	<span><span id="pop_titles"></span><span id="pop_sizes"></span></span>
	            </div>
	            <div class="alert alert-warning" role="alert">抱歉，您的<span class="pointName"></span>不足，不能下载该文档！</div>
	            <p>下载文档，需要支付<span class="tn-red-color tn-font-20" id="pop_prices"></span>个<span class="pointName"></span></p>
	            <p>您当前持有<span id="pop_userprices"></span>个<span class="pointName"></span></p>
	            <div class="mui-popup-buttons">
	                <span class="mui-popup-button">
	                    <button class="mui-btn mui-btn-primary" id="closeDownload">关闭</button>
	                </span>
	            </div>
	        </div>
	    </div>
	    
	   	<div id="scorePop" class="jh-wenku-popup mui-popover downloadpop" style="position: fixed;z-index: 99999999999;">
	        <div class="mui-popup-inner" style="border-radius:13px">
	            <div class="mui-popup-title" style="text-align: center;" id="scoreTitle"></div>
	            <div id="starts"></div>
	            <div class="mui-popup-buttons">
	                <span class="mui-popup-button">
	                    <button class="mui-btn mui-btn-primary" id="confirmScore">确定</button>
	                </span>
	            </div>
	        </div>
	    </div>
		<div  class="mui-content jh-detail-content" style="background-color: #000;">
				<div class="detail_content" id="new_detail" style="min-height:350px">
					
					<div  id="videoArea">
						<!--<video id="video" class="myVideo" webkit-playsinline playsinline width="100%">
							<source src="http://192.168.0.12/webdav/ContentItem/2017/03/23/636258884556673447.mp4" type='video/mp4'>
							<source src='1.webm' type="video/webm"></source>
							<p>设备不支持</p>
						</video>-->
					</div>
					<div class="mui-content-padded" style="background-color: #000;min-height: 300px;" id="newContent">
						<h4 class="jh-detail-title mui-content-padded" style="color: #CBCBCB;" id="documentTitle"></h4>
						<div class="detail_content mui-content-padded" style="color: #CBCBCB;" id="Summary"></div>
					</div>

				</div>
			
			
								

				
				

				<div class="mui-bar mui-bar-tab jh-bar-comment" style="padding: 0px 10px;">

			</div>
			<div id="reportContainer" class="jh-medal-popover box mui-popover" style="background-color: #fff;display: none;padding: 0px !important;">
				<ul class="mui-table-view jh-word-vote" id="itemContainer">
					<span style="margin-left: 15px;">举报原因</span><span style="color: red;">*</span>
					<form class="mui-input-group" style="background-color: #fff;margin-bottom: 0px;">
						<div class="mui-input-row mui-radio">
							<span style="margin-left: 25px;">恶意灌水</span>
							<input name="style" type="radio" class="mui-pull-left" id="1"/>
						</div>
						<div class="mui-input-row mui-radio">
							<span style="margin-left: 25px;">淫秽色情</span>
							<input name="style" type="radio" class="mui-pull-left" id="2"/>
						</div>
						<div class="mui-input-row mui-radio">
							<span style="margin-left: 25px;">内容侵权</span>
							<input name="style" type="radio" class="mui-pull-left" id="3"/>
						</div>
						<div class="mui-input-row mui-radio">
							<span style="margin-left: 25px;">广告诈骗</span>
							<input name="style" type="radio" class="mui-pull-left" id="4"/>
						</div>
						<div class="mui-input-row mui-radio">
							<span style="margin-left: 25px;">其他</span>
							<input name="style" type="radio" class="mui-pull-left" id="99"/>
						</div>
					</form>
				</ul>
		    	<ul class="mui-table-view">
					<li style="padding-bottom: 0px; font-size: 16px;padding: 6px 10px;">
						<textarea id="reason" rows="2" placeholder="请输入举报原因"></textarea>
					</li>
				</ul>
				<p>
					<button class="Fbutton" style="border-radius: 0px 0px 0px 5px;color: #999;" id="cancelReport">取消</button>
					<button class="Fbutton" id="submitReport" style="color: #bf0a10;border-right: none;border-left:none;float: right;border-radius: 0px 0px 5px 0px;">确定</button>
				</p>
		    </div>
			
			<script src="../js/mui.min.js"></script>
			<script src="../js/mui.zoom.js"></script>
			<script src="../js/mui.previewimage.js"></script>
			<script src="../js/service.js"></script>
			<script src="../js/common.js"></script>
			<script src="../js/comment.js"></script>
			<script src="../js/share.js"></script>
			<script src="../js/bvd.js"></script>
			<script src="../js/wxHelper.js"></script>
			<script src="../js/jweixin-1.2.0.js"></script>
			<script src="../js/openApp.js"></script>
			<script src="../js/jquery-2.1.0.js"></script>
			<script src="../js/jquery.raty.min.js"></script>
			<script src="https://static.mlinks.cc/scripts/dist/mlink.min.js"></script>
			<script src="../js/document.js"></script>
	</body>
	<script>
		var ManagerLevel=0;
		var canDownload=false;
		var userStarReview=0;
		var documentTitle='';
		var documentId=0;
		var currId = "";
		var isDownload=false;
		var isEssential=false;
		var isSticky=false;
		
		$(function(){  
	        $("#starts").raty({  
	            number : 5,//星星个数  
	            readOnly: false,
	            path : 'img',//图片路径  
	            starOn : '../../img/pf-on.png',//黄色星星图片（可自定义）  
	            starOff : '../../img/pf-off.png',//灰色星星图片（可自定义）    
	            click : function(score, evt) {  
	            	userStarReview=score;
	            }  
	        });   
		}); 
		var videoArea = document.getElementById("videoArea");

		var height = document.documentElement.clientHeight || document.body.clientHeight;
		document.querySelector('.jh-detail-content').style.minHeight = height + 'px';
		var CategoryName = document.getElementById("CategoryName");
		var Title = document.getElementById('documentTitle');
		var Summary = document.getElementById('Summary');
		var EssentialOperation = document.getElementById("EssentialOperation"); //精华
		var StickyOperation = document.getElementById("StickyOperation"); //置顶
		var Deletedocument = document.getElementById("Deletedocument"); //删除
		var documentOpt = document.getElementById("documentOpt");
		var documentState = document.getElementById("documentState");
		var commentArea = document.getElementById("commentArea");
		var pop_title=document.getElementById("pop_title");
		var pop_size=document.getElementById("pop_size");
		var pop_price=document.getElementById("pop_price");
		var pop_userprice=document.getElementById("pop_userprice");
		var pop_titles=document.getElementById("pop_titles");
		var pop_sizes=document.getElementById("pop_sizes");
		var pop_prices=document.getElementById("pop_prices");
		var pop_userprices=document.getElementById("pop_userprices");
		var docdownload=document.getElementById("docdownload");
		var editDoc = document.getElementById('editDoc');
		var uip = document.getElementById("popover"); //topPopover是popover 的最外层div
		uip.style.position = "absolute";
		var islog = getlsData('isLogin');
		//documentOpt.style.display = (islog == 'true') ? 'inherit' : 'none';

		if(!mui.os.plus) {
			creatBanner();
		}
		showLoading('', '', '#000000', '50px');
		mui.init();
		if(mui.os.wechat) {
			initWx();
			wx.ready(function() {
				wx.checkJsApi({
					jsApiList: ['previewImage'], // 需要检测的JS接口列表，所有JS接口列表见附录2,
					success: function(res) {
						// 以键值对的形式返回，可用的api值true，不可用为false
						// 如：{"checkResult":{"chooseImage":true},"errMsg":"checkJsApi:ok"}
					}
				});
			});
			wx.error(function(res) {

			});
		}
		currId = "";
		//B页面onload从服务器获取列表数据；
		window.onload = function() {
			//获取url中的targetId参数
			if(mui.os.plus) {
				mui.plusReady(function() {
					var self = plus.webview.currentWebview();
					documentId = self.documentId;
					currId = self.currId;
					beforetype = self.type;
					getDetail(documentId)
					//关闭等待框
					plus.nativeUI.closeWaiting();
					//显示当前页面
					mui.currentWebview.show();
				});
			} else {
				documentId = getUrlParam('documentId');
				getDetail(documentId)
			}
			if(!mui.os.plus) {
				initOpenApp('docVideoDetail', documentId)
			}
			if(mui.os.wechat) {
				var currUrl = location.href.split('#')[0];
				weChatLogin(currUrl)
			}

		}
		function setPopHeight(idname) { 
			var height = document.documentElement.clientHeight || document.body.clientHeight;
			var popHeight = parseInt(window.getComputedStyle(document.getElementById(idname), null).minHeight);
			document.getElementById(idname).style.top = (height - popHeight)/2 + 'px';
		}
		document.getElementById('cancelReport').addEventListener('tap',function(){
			mui('#reportContainer').popover('toggle');
		})
		document.getElementById('submitReport').addEventListener('tap',function(){
			var checked = false;
			for(var i = 0;i<document.getElementById('itemContainer').getElementsByTagName('input').length;i++){
				if(document.getElementById('itemContainer').getElementsByTagName('input')[i].checked == true){
					checked = true;
					var id = document.getElementById('itemContainer').getElementsByTagName('input')[i].id;
				}
			}
			if(checked == false){
				mui.toast("请选择举报原因");
				return;
			}
			var Description = TrimAll(document.getElementById('reason').value);
			EditReport(id,Description);
			mui('#reportContainer').popover('toggle');
		})
		var subject;
		function EditReport(id,Description){
			var params = {
				TenantTypeId:101200,
				Reason:id,
				Title:subject,
				Description:Description,
				ReportObjectId:documentId
			}
			postDatawithToken('User/EditReport',params, function(data) {
				if(data.Type == 1) {
					mui.toast(data.Data);					
				} else if(data.Type == 0) {
					//登录失败
					mui.toast("请登录后再进行操作");
					login();
					return;
				} else {
					//逻辑错误					
					mui.toast(data.Data);
					return;
				}
			}, function(data) {
				hideLoading()
			});
		}

		function creatVideoEl(vurl) {
			var div;
			div = document.createElement('div');
			div.className = 'bad-video';

			div.innerHTML = '<video id="video"  webkit-playsinline playsinline class="myVideo">' +
				'	<source src=' + vurl + ' type=\'video/mp4\'>' +
				'	<source src=\'1.webm\' type="video/webm"></source>' +
				'	<p>设备不支持</p>' +
				'</video>';
			videoArea.appendChild(div);
		}
		function updateEssential(isEssential){
			if(isEssential){
				EssentialOperation.innerHTML = '<a><i class="fa fa-star-o" aria-hidden="true"></i>&nbsp;&nbsp加精</a>'
			}else{
				EssentialOperation.innerHTML = '<a><i class="fa fa-star-o" aria-hidden="true"></i>&nbsp;&nbsp取消加精</a>'
			}
			
		}
	    mui('body').on('shown', '.mui-popover', function(e) {
	    	if(!mui.os.plus&&(mui.os.ios && parseFloat(mui.os.version) <8)){
	    		document.getElementById("video").classList.add("mui-hidden");
	    	}
        });
     	 mui('body').on('hidden', '.mui-popover', function(e) {
     	 	if(!mui.os.plus&&(mui.os.ios && parseFloat(mui.os.version) <8)){
     	 		 document.getElementById("video").classList.remove("mui-hidden");	
     	 	}
        });
		function updateSticky(isSticky){
			if(isSticky){
				StickyOperation.innerHTML = '<a><i class="fa fa-chevron-up" aria-hidden="true"></i>&nbsp;&nbsp置顶</a>'
			}else{
				StickyOperation.innerHTML = '<a><i class="fa fa-chevron-down" aria-hidden="true"></i>&nbsp;&nbsp取消置顶</a>'
			}
		}
		var beforetype;
		mui("#popover").on('tap', '#editDoc', function(e) {
			mui('#popover').popover('hide');
				var baseUrl = 'editDoc.html';
				var url = mui.os.plus ? baseUrl : baseUrl + '?documentId=' + documentId;
				mui.openWindow({
					url: url,
					id: 'editDoc.html',
					show: {
						autoShow: true
					},				
					waiting: {
						options: {
							loading: {
								height: '35px'
							}
						}
					},
					extras: {
						documentId: documentId,
						type:beforetype
					}
				})
		})
		var isFavorited = false;

		function getDetail(id) {
			showLoading('', '', '#000000', '50px');
			getDatawithToken('Document/GetDetail', {
				documentId: id
			}, function(data) {
				hideLoading();
				hideErr();
				if(data.Type == 1) {
					if(data.Data && typeof(data.Data) == 'object') {
						var data = data.Data;
						updateEssential(!data.IsEssential);
						updateSticky(!data.IsSticky);
						editDoc.style.display = data.IsAllowMobileEdit == true && data.ManagerLevel >　0 ?　'block' :　'none';
						setIdandType(documentId, 'Document', data.CommentCount)
						creatVideoEl(getImgUrl(data.AttachmentUrl));
						console.log(getImgUrl(data.AttachmentUrl));
						Title.innerHTML = data.Subject;
						Summary.innerHTML = data.Summary;
						pop_title.innerHTML = data.Subject;
						pop_size.innerHTML='（'+data.FriendlyFileLength+'）';
						pop_price.innerHTML=data.Price;
						pop_userprice.innerHTML=data.UserGold;
						pop_titles.innerHTML = data.Subject;
						subject = data.Subject;
						pop_sizes.innerHTML='（'+data.FriendlyFileLength+'）';
						pop_prices.innerHTML=data.Price;
						pop_userprices.innerHTML=data.UserGold;
						userid = data.UserId;
						EssentialOperation.style.display = (islog == 'true') ? 'inherit' : 'none';
						StickyOperation.style.display = (islog == 'true') ? 'inherit' : 'none';
						if(data.IsEssential) {
							//精华
							EssentialOperation.innerHTML = '<a><i class="fa fa-star-o" aria-hidden="true"></i>&nbsp;&nbsp取消加精</a>'
						} else {
							//非精华
							EssentialOperation.innerHTML = '<a><i class="fa fa-star" aria-hidden="true"></i>&nbsp;&nbsp加精</a>'
						}
						if(data.IsSticky) {
							//置顶
							StickyOperation.innerHTML = '<a><i class="fa fa-chevron-down" aria-hidden="true"></i>&nbsp;&nbsp取消置顶</a>';
						} else {
							//非置顶
							StickyOperation.innerHTML = '<a><i class="fa fa-chevron-up" aria-hidden="true"></i>&nbsp;&nbsp置顶</a>';
						}
						docCanComment(data.EnableComment);
						docCanDownload(data.EnableDownload);
						setShareInfo(getlsData('currUrl'), data.Subject, data.Subject);
						com.isFavorited = data.IsFavorite;
						favorDoc(data.IsFavorite);
						isDownload=data.IsDownload;
						if(data.ManagerLevel == 0) {
							//documentOpt.style.display = 'none';
							document.getElementById("Deletedocument").style.display = 'none';
						}
						if(data.ManagerLevel == 1){
							document.getElementById("EssentialOperation").style.display = 'none';
							document.getElementById("StickyOperation").style.display = 'none';
						}
						if(data.ManagerLevel == 2){
							documentOpt.style.display = 'inherit';
						}
						if(data.UserGold>=data.Price){
							canDownload=true;
						}else{
							canDownload=false;
						}
						ManagerLevel=data.ManagerLevel;
						if(data.UserStarReview>0){
							//已经评价过
							isScore=true
						}
						ScoreDoc(isScore,data.UserStarReview);
						documentTitle=data.Subject+'.'+data.Extension;
						for(var i=0;i<document.querySelectorAll('.pointName').length;i++){
							document.querySelectorAll('.pointName')[i].innerHTML=data.PointName
						}
						mui.bvd();
					} else {
						documentOpt.style.display = 'none';
						showErr(data.Data, '', '#000000', '50px')
						mui.toast(data.Data);
					}
				}else {
					//逻辑错误
					documentOpt.style.display = 'none';
					showErr(data.Data, '', '#000000', '50px')
					mui.toast(data.Data);
					return;
				}
			}, function(err) {
				documentOpt.style.display = 'none';
				setErr('#000000','50px')
			})
		}
		documentOpt.addEventListener('tap', function() {
				mui('#popover').popover('toggle');			
		})

		function documentHandle(type) {
			showLoading();
			var url = 'Document/DocumentHandle?documentId=' + documentId + '&method=' + type;
			if(type == 'delete') {
				url = 'Document/DeleteDocument?documentId=' + documentId;
			}
			postDatawithToken(url, {}, function(data) {
				hideLoading();
				if(data.Type == 1) {
					mui.toast(data.Data);
					if(mui.os.plus){
						var wobj = plus.webview.getWebviewById(currId);
						wobj.reload(true);
					}
					switch (type){
						case "essential":
							updateEssential(isEssential)
							isEssential=!isEssential;
							break;
						case "sticky":
							updateSticky(isSticky)
							isSticky=!isSticky;
							break;
					}
				} else if(data.Type == 0) {
					//登录失败
					mui.toast("请登录后再进行操作");
					login();
					return;
				} else {
					//逻辑错误
					mui.toast(data.Data);
					return;
				}
			}, function(err) {
				setErr('','',false)
			})
		}
		mui(".mui-list-unstyled").on('tap', 'li', function(e) {
			mui('#popover').popover('toggle');
			switch(this.getAttribute('id')) {
				case "EssentialOperation":
					//加精or取消加精
					documentHandle('essential')
					break;
				case "StickyOperation":
					//置顶or取消置顶
					documentHandle('sticky')
					break;
				case "report":
					//举报
					mui('#popover').popover('toggle');
					if(islog == 'true'){
						mui('#reportContainer').popover('toggle');
						setPopHeight('reportContainer');
					}else{
						login();
					}
					break;
				case "Deletedocument":
					//删除
					mui('#popover').popover('toggle');
					var btnArray = ['取消', '确定'];
					mui.confirm('确认删除？', '文档', btnArray, function(e) {
						if(e.index == 1) {
							documentHandle('delete');
							if(mui.os.plus) {
								mui.back()
							}
						}
					});
					break;
				default:
					break;
			}
		})
		function setPopHeight(idname){
			var height = document.documentElement.clientHeight || document.body.clientHeight;
			var popHeight=parseInt(document.getElementById(idname).offsetHeight);
			document.getElementById(idname).style.top=(height-popHeight)/2+'px';
		}
	
	</script>

</html>