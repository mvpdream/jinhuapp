<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--通用样式-->
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../css/icons-extra.css" />
		<link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/question-list.css" />
		<link rel="stylesheet" href="../css/jinhu.css">
	</head>
	<style>
		.mui-fullscreen .mui-segmented-control~.mui-slider-group {
		    position: absolute;
		    top: 50px;
		    bottom: 0;
		    width: 100%;
		    height: auto;
		}
		.status{
			display: inline-block;
		}
		.status span:first-child{
			margin-left: -7px !important;
		}
		.subject{
			padding: 9px 10px 0px 10px;
		}
		.jh-hot-label{
			padding-bottom: 2px;
		}
		.content{
			word-wrap: break-word;
			display: inline-block;
		}
		.mui-bar~.mui-content .mui-fullscreen {
			top: 44px;
			height: auto;
		}	
		.mui-pull-top-tips {
			position: absolute;
			top: -20px;
			left: 50%;
			margin-left: -25px;
			width: 40px;
			height: 40px;
			border-radius: 100%;
			z-index: 1;
		}		
		.mui-bar~.mui-pull-top-tips {
			top: 24px;
		}
		.jh-orange {
    		color: #FF9900;
		}
		.mui-pull-top-wrapper {
			width: 42px;
			height: 42px;
			display: block;
			text-align: center;
			background-color: #efeff4;
			border: 1px solid #ddd;
			border-radius: 25px;
			background-clip: padding-box;
			box-shadow: 0 4px 10px #bbb;
			overflow: hidden;
		}		
		.mui-pull-top-tips.mui-transitioning {
			-webkit-transition-duration: 200ms;
			transition-duration: 200ms;
		}		
		.mui-pull-top-tips .mui-pull-loading {
			margin: 0;
		}		
		.mui-pull-top-wrapper .mui-icon,
		.mui-pull-top-wrapper .mui-spinner {
			margin-top: 7px;
		}				
		.mui-pull-bottom-tips {
			text-align: center;
			background-color: #efeff4;
			font-size: 15px;
			line-height: 40px;
			color: #777;
		}		
		.mui-pull-top-canvas {
			overflow: hidden;
			background-color: #fafafa;
			border-radius: 40px;
			box-shadow: 0 4px 10px #bbb;
			width: 40px;
			height: 40px;
			margin: 0 auto;
		}		
		.mui-pull-top-canvas canvas {
			width: 40px;
		}		
		.mui-slider-indicator.mui-segmented-control {
			background-color: #efeff4;
		}		
		.typeitem {
			text-align: center;
			border: 1px solid #BCBCBC;
			height: 35px;
			padding-top: 5px;
			padding-right: 10px;
		}
		.fa-padding {
            height: 20px;
		}		
		.jh-title {

			padding-left: 0px;
			max-width: 87%;
			min-width: 35%;

		}
		.mui-bar{
			height: auto;
		}
		#tagname{
			white-space: normal;
    		max-width: 92%; 
    		text-align: inherit;
		}
		#tagname p{
			display: inline;
		}
		.fa-tagname{
			padding-left: 13.5px;
    		padding-right: 13.5px;
		}
		.author{
			overflow: hidden;
		    text-overflow: ellipsis;
		    max-width: 36%;
		    white-space: nowrap;
		}
	</style>

	<body style="background-color: #FFFFFF;">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color:#333;"></a>			
			<a href="#"><span class="label label-default" style="margin-top: 10px;" id="tagname">
				<i class="fa fa-tags text-muted head-label " aria-hidden="true"  ></i><p>标签名称</p></span></a>
			<div id="split"></div>
		</header>
		<div class="mui-content" id="contentArea" style="display: block">			
			<div id="slider" class="mui-slider mui-fullscreen"> 
				<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted jh-scroll-wrapper">
					<div class="mui-scroll" id="SectionType" style="padding-right: 40px;">
						<a class="mui-control-item mui-active" href="#itemmobile" id="0">
							最新
						</a>
						<a class="mui-control-item" href="#item0mobile" id="1">
							待解决
						</a>
				        <a class="mui-control-item" href="#item1mobile" id="2">
							高悬赏
						</a>
				        <a class="mui-control-item" href="#item2mobile" id="3">
							精华
						</a>			
					</div>
				</div>
				<div class="jh-gray-bar"></div>
				<div class="mui-slider-group" id="sliderGroup">
					<div id="itemmobile" class="mui-slider-item mui-control-content mui-active">
						<div class="mui-scroll-wrapper"id="refreshContainer">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<div class="mui-loading">
										<div class="mui-spinner">
										</div>
									</div>
								</ul>
							</div>
						</div>
					</div>
					<div id="item0mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper"id="refreshContainer1">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<div class="mui-loading">
										<div class="mui-spinner">
										</div>
									</div>
								</ul>
							</div>
						</div>
					</div>
				    <div id="item1mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper"id="refreshContainer2">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<div class="mui-loading">
										<div class="mui-spinner">
										</div>
									</div>
								</ul>
							</div>
						</div>
					</div>
				    <div id="item2mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper"id="refreshContainer3">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<div class="mui-loading">
										<div class="mui-spinner">
										</div>
									</div>
								</ul>
							</div>
						</div>
					</div>					
				</div>			
		   </div>
		<div class="jh-write-question"id="setting_btn">
			<i id="setting_btn" class="fa fa-plus mui-icon mui-icon-bars mui-pull-right" aria-hidden="true" style="color:#fff;"></i>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/mui.pullToRefresh.js"></script>
		<script src="../js/mui.pullToRefresh.material.js"></script>
		<script src="../js/service.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/wxHelper.js"></script>
	</body>
	<script type="text/javascript">
		var tagName;	
	var tabIndex=0;
	var pageindex = 1;
	var slider = document.getElementById("slider");
	var split = document.getElementById("split");
	var ids = [];	
	var selel = document.getElementsByClassName("mui-control-item mui-active");				
	var page = 1;
	var idName = "";
	mui('.mui-slider').slider();
	var deceleration = mui.os.ios ? 0.003 : 0.0009;
	mui('.mui-scroll-wrapper.mui-slider-indicator.mui-segmented-control').scroll({
		scrollY: false,
		scrollX: true,
		indicators: false,
		deceleration: deceleration,
		snap: '.mui-control-item'
	});			
	document.querySelector('.mui-slider').addEventListener('slide', function(event) {
		tabIndex = event.detail.slideNumber;
		if(event.detail.slideNumber != 0) {
			var index = event.detail.slideNumber -1;//(index - 1)
			var item = document.getElementById("item" + index + "mobile");
			item.querySelector('.mui-pull-bottom-tips').style.display = 'none';
			if(item.querySelector('.mui-loading')) {
				if(index == 1) {
					GetQuestionByList(false,3,null,tagName)							
				}
				if(index == 2) {
					GetEssentialQuestionsByList(tagName,false)
				}
				if(index == 0){
					GetQuestionByList(false,0,0,tagName)
				}
			}
		}
	});
	document.getElementById("setting_btn").addEventListener('tap', function() {
		var islog = getlsData('isLogin');
		if(islog == 'true') {
			var baseUrl = 'creatQuestion.html';
			var url = mui.os.plus ? baseUrl : baseUrl ;
			mui.openWindow({
				url: url,
				id: 'creatQuestion.html',
				show: {
					autoShow: true
				},
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				}
			})
		} else {
			mui.toast('请登录后再进行操作');
			login();
		}
	});		
	if(mui.os.plus) {
		mui.plusReady(function() {					
			var self = plus.webview.currentWebview();
			tagName = self.tagName;	
			var tagname = document.getElementById("tagname");
		    tagname.innerHTML = '<i class="fa fa-tags text-muted head-label" aria-hidden="true"style="padding-top: 1px;margin-left:-10px;display: block;float: left;"></i><p>'+tagName+'</p>';
			split.style.height = "1px";
			if(tagname.offsetHeight > 40){
				slider.style.top = (document.getElementById("split").offsetTop + 1) + 'px';
			}
		});
	} else { 
		tagName = getUrlParam('tagName');
		var tagname = document.getElementById("tagname");
		tagname.innerHTML = '<i class="fa fa-tags text-muted head-label" aria-hidden="true"style="padding-top: 1px;margin-left:-10px;display: block;float: left;"></i><p>'+tagName+'</p>';
		split.style.height = "1px";
		if(tagname.offsetHeight > 40){
			slider.style.top = (document.getElementById("split").offsetTop + 1) + 'px';
		}
	}
	mui(".mui-table-view").on('tap','.mui-content',function(e){	
		var questionId = this.getAttribute('id');
		var baseUrl = 'question-solved.html';
		var url = mui.os.plus ? baseUrl : baseUrl + '?questionId=' + questionId;
		var curl = shareUrl+baseUrl+ '?questionId=' + questionId;
		setlsData('currUrl', curl);				
		mui.openWindow({
			url: url,
			id: 'question-solved.html',
			show: {
				autoShow: true
			},
			createNew:true,
			waiting: { 
				options: {
					loading: {
						height: '35px'
					}
				} 
			},
			extras: {
				questionId: questionId,
				tabIndex:tabIndex,
				type:'questionlist',
				currId: 'question-label-list.html'
			}
		})
	})
	var creatAskElementByList = function(data, id,more) {
		var fragment = document.getElementById(id);
		var cfragment = fragment.firstElementChild;
		var finel = cfragment.firstElementChild.querySelector('.mui-table-view');
		var newFragment = document.createDocumentFragment();
		var Essential;
		var Reward;			
		var tagsLength = [];//标签长度的数组
		var tagsSort =[];//标签排序好后的数组
		var li;
		var bigContainer;			
		for(var i = 0; i < data.length; i++) {
			span = document.createElement('span');
			var resolved ="";
			var Author;
			var dis = 'none';
			classn = data[i].IsResolved ? 'jh-green-border' : 'jh-red-border';
			text1 = data[i].IsResolved ? "已解决" : "未解决";
			resolved = '<span class='+classn+'>' + text1 +	'</span>'				
			bigContainer = "";				
			tagsLength = [];
			Reward = data[i].Reward == 0 ? '' : '<li class="jh-orange"><i class="fa fa-database"></i><span>' + data[i].Reward + '</span></li>';
			Essential = data[i].IsEssential == true ? '<span class="jh-red-border">' + "精华" + '</span>' : '';				
			Author = data[i].IsAnonymous ? '<li>' + "匿名用户 "+ '</li>' : '<li class="author">' + data[i].Author  + '</li>';
			if(data[i].Tags.length != 0){
				for(var j = 0;j<data[i].Tags.length;j++){
					tagsLength.push({TagName:data[i].Tags[j].TagName,length:data[i].Tags[j].TagName.length});
					function compare(property){
						return function(a,b){
							var value1 = a[property];
							var value2 = b[property];
							return value1 - value2;
						}
					}
				}
				tagsSort = tagsLength.sort(compare('length'))
				var lengthL = tagsSort.length ;
				var tagsFinal = tagsSort.slice(0,lengthL);//最终排序好的数组
				for(var r = 0; r < tagsFinal.length; r++) {
					bigContainers = "";
					itemContainer = '<a  class="tagname" id=' + tagsFinal[r].TagName + '><span class="label label-default" id="tagH">' + tagsFinal[r].TagName+ '</span></a>'
					bigContainer += itemContainer;
				}
			}else{
				var disTag = 'none';
			}
			div = document.createElement('div');
			div.className = 'mui-content question-list';
			div.id = data[i].Id;
			div.innerHTML = '<div class="mui-content-padded">' +
							'<div class="subject">'+
							'<p class="content" id='+data[i].Id+'>' + data[i].Subject + 				
							'<span class="status">'+
				            resolved +
				            Essential+
				            '</span>'+
							'</p>' +
							'</div>'+
							'<div class="mui-row" style="margin-top:1px;"> '+
							'<div class="jh-hot-label" style="display:'+ disTag +'">'+
							'<i class="fa fa-tags text-muted fa-padding" aria-hidden="true"></i>'+
				            '<div class="jh-title">'+bigContainer+'</div>'+				                                               
							'</div>  '+
							'<ul class="mui-list-inline text-muted" >'+
							Reward+
							Author+
							'<li>' + data[i].DateCreated + '</li>' +
							'<li>' + data[i].HitTimes +'浏览' +'</li>' +
							'<li>' + data[i].AnswerCount +'回答' +'</li>' +				
							'</ul>'+
							'</div>'+
							'</div>'+
							'</div>'+
							'<div class="jh-gray-bar"></div>';
				if(more == true){
					finel.appendChild(div);
				}else{
					newFragment.appendChild(div);
				} 
			}
			if(more == false){
				finel.innerHTML=nodeToString(newFragment);
			}
		};
	function GetEssentialQuestionsByList(tagName,more) {
		//showLoading()
		var idName = selel[0].href.substring(selel[0].href.lastIndexOf("#") + 1, selel[0].href.length);
		var fragment = document.getElementById(idName);
		var cfragment = fragment.firstElementChild;
		var finel = cfragment.firstElementChild.querySelector('.mui-table-view');
		if(more) {
			pageindex++;
		} else {
			//finel.innerHTML = '';
			pageindex = 1;
		}
		var params = {
			tagName : tagName,
			pageSize: 10,
			pageIndex: pageindex
		};
		getData('Ask/GetEssentialQuestions', params, function(data) {
			var bottomTip = document.querySelectorAll('.mui-pull-bottom-tips');
			hideLoading();
			console.log(data)
			if(data.Type == 1) {
				if(data.Data.length > 0 && typeof(data.Data) == 'object') {
					if(data.Data.length <= 5) {
						document.getElementById("item2mobile").querySelector('.mui-pull-bottom-tips').style.display = 'none';
					} else {
						document.getElementById("item2mobile").querySelector('.mui-pull-bottom-tips').style.display = 'block';														
					}
					creatAskElementByList(data.Data, idName,more);
				} else {
					document.getElementById("item2mobile").querySelector('.mui-loading').style.display = 'none';
					if(!more){
						var errForList=showErrForList(data.Data,'','',idName);
						if(errForList){
							fragment.appendChild(showErrForList(data.Data,'','',idName))
						}
					}
					document.getElementById("item2mobile").querySelector('.mui-pull-loading').innerHTML = data.Data;
				}
			} else if(data.Type == 0) {
				//登录失败
				mui.toast("请登录后再进行操作");
				login();
				return;
			} else {
				//逻辑错误					
				mui.toast(data.Data);
				return;
			}
		}, function(err) {
			hideLoading();
		})
	}
	(function($) {
		//阻尼系数
		var deceleration = mui.os.ios ? 0.003 : 0.0009;
		$('.mui-scroll-wrapper').scroll({
			bounce: false,
			indicators: true, //是否显示滚动条
			deceleration: deceleration
		});
		$.ready(function() {
			//循环初始化所有下拉刷新，上拉加载。
			$.each(document.querySelectorAll('.mui-slider-group .mui-scroll'), function(index, pullRefreshEl) {
				$(pullRefreshEl).pullToRefresh({
					down: {
						callback: function() {
							var self = this;
							document.getElementById(idName).querySelector('.mui-pull-bottom-tips').style.display = 'none';
							if(selel[0].id == '1') {
								GetQuestionByList(false,0,0,tagName)
							}
							if(selel[0].id == '0'){
								GetQuestionByList(false,0,null,tagName)
							}
							if(selel[0].id == '2') {
								GetQuestionByList(false,3,null,tagName)
							}
							if(selel[0].id == '3'){
								GetEssentialQuestionsByList(tagName,false)
							}
							setTimeout(function() {
								self.endPullDownToRefresh();
							}, 1000);
						}
					},
					up: {
						callback: function() {
							var self = this;
							if(selel[0].id == '0'){
								GetQuestionByList(true,0,null,tagName)
							}
							if(selel[0].id == '1') {
								GetQuestionByList(true,0,0,tagName)
							}						
							if(selel[0].id == '2') {
								GetQuestionByList(true,3,null,tagName)
							}
							if(selel[0].id == '3'){
								GetEssentialQuestionsByList(tagName,true)
							}
							setTimeout(function() {
								self.endPullUpToRefresh();
							}, 1000);
						}
					}
				});
			});
		});
	})(mui); 
	window.onload = function() {
		//获取url中的targetId参数
		if(mui.os.plus) {
			mui.plusReady(function() {					
				var self = plus.webview.currentWebview();
				tagName = self.tagName;	
				GetQuestionByList(false,0,null,tagName)
				//关闭等待框                                                                                                               
				plus.nativeUI.closeWaiting();
				//显示当前页面                                                                                                              
				mui.currentWebview.show();
			});
		} else {	
			tagName = getUrlParam('tagName');
			GetQuestionByList(false,0,null,tagName)
		}	
		if(mui.os.wechat){
			var currUrl = location.href.split('#')[0];
			weChatLogin(currUrl)
		}
	}
	function GetQuestionByList( more,sortBy,status,tagName) {
//		if(!more) {
//			showLoading('', '', '#FFFFFF', '90px', '1');
//		}
		var selel = document.getElementsByClassName("mui-control-item mui-active");
		idName = selel[0].href.substring(selel[0].href.lastIndexOf("#") + 1, selel[0].href.length);
		var fragment = document.getElementById(idName);
		var cfragment = fragment.firstElementChild;
		var finel = cfragment.firstElementChild.querySelector('.mui-table-view');
		if(more) {
			page++;
		} else {
			//finel.innerHTML = '';
			page = 1;
		}
		var params = {				
			status :status,
			sortBy : sortBy,
			tagName : tagName,
			pageSize: 10,
			pageIndex: page,							
		};
		getData('Ask/GetQuestions', params, function(data) {
			hideLoading();
			hideErr();
			var bottomTip = document.querySelectorAll('.mui-pull-bottom-tips');
			if(data.Type == 1) {
				if(data.Data && typeof(data.Data) == 'object') {
					hideErrForList('',idName);
					if(data.Data.length <= 5) {
						document.getElementById(idName).querySelector('.mui-pull-bottom-tips').style.display = 'none';
					} else {
						document.getElementById(idName).querySelector('.mui-pull-bottom-tips').style.display = 'block';
					}
					creatAskElementByList(data.Data, idName,more);
				} else {
					document.getElementById(idName).querySelector('.mui-loading').style.display = 'none';
					if(!more){
						var errForList=showErrForList(data.Data,'','90px',idName);
						if(errForList){
							fragment.appendChild(showErrForList(data.Data,'','90px',idName))
						}
					}
				}
			} else if(data.Type == 0) {
				//登录失败
				mui.toast("请登录后再进行操作");
				login();
				return;
			} else {
				//逻辑错误	
				var errForList=showErrForList(data.Data,'','90px',idName);
				if(errForList){
					fragment.appendChild(showErrForList(data.Data,'','90px',idName))
				}
				mui.toast(data.Data);					
				return;
			}
		}, function(err) {
			setErr('','90px')
		})
	}
	function changeTabByList(index){			
		var gallery = mui('#sliderSegmentedControl');
		var gallerys = mui('#slider');
		gallery.scroll().gotoPage(index);
		gallerys.slider().gotoItem(index);
		if(index == 1) {
			GetQuestionByList(false,0,0,tagName)
			mui('#refreshContainer1').scroll().scrollTo(0,0);
		}
		if(index == 2) {
			GetQuestionByList(false,3,null,tagName)
			mui('#refreshContainer2').scroll().scrollTo(0,0);
		}
		if(index == 0){		
			GetQuestionByList(false,0,null,tagName)					
			mui('#refreshContainer').scroll().scrollTo(0,0);
		}
		if(index == 3){
			GetEssentialQuestionsByList(tagName,false)
			mui('#refreshContainer3').scroll().scrollTo(0,0);
		}		
	}		
	mui.init({			
		gestureConfig: {
			swipeBack: true //启用右滑关闭功能
		},
	});	
	</script>
</html>