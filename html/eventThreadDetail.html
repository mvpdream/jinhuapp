<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>活动详情</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--通用样式-->
		<link rel="stylesheet" href="../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/icons-extra.css" />
		<link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css" />
		<link rel="stylesheet" href="../css/jinhu.css" />
	</head>
	<style>
		.jh-dropdown-list{
			border: none;
		}
		.detail_content {
			background-color: #FFFFFF;
		}
		
		.creator_img_comment {
			width: 2rem !important;
			height: 2rem !important;
		}
		#reportContainer{
			position: fixed;
			margin-left: 5%;
			min-height: 375px;
			background-color: #ffffff;
		}
		#reportContainer button{
			width: 50%;
		    height: 40px;
		    line-height: 24px;
		    border-right: 1px solid #eff2f9;
		    border-top: none;
		    border-bottom: none;
		    text-align: center;
		    margin-right: 0px;
		}
		#reportContainer p {
			margin-bottom: 0px;
		    height: 40px;
		    line-height: 40px;
		    width: 100%;
		    border-top: 1px solid #eff2f9;
		}
		#reportContainer ul{
			background-color: #fff;
			margin: 5px 5px;
			padding: 3px;
		}
	</style>

	<body style="background-color: #fff;">
		<header class="mui-bar mui-bar-nav">
			<button class="mui-action-back mui-btn mui-btn-link mui-btn-nav mui-pull-left" style="color:#333333">
				<span class="mui-icon mui-icon-left-nav"></span>
			</button>
			<span class="mui-pull-left" style="line-height: 50px;">
				<span style="color: #e4e4e4;font-size: 14px;padding: 0 2px 0 2px;">|</span>
			<button class="mui-btn mui-btn-link" id="SectionName" style="color: #000000;font-size: 15px;"></button>
			</span>

			<a id="threadOpt" class="mui-icon mui-icon-bars mui-pull-right" style="color: #333;"></a>
		</header>

		<div id="popover" class="mui-popover" style="position:fixed;width: 130px;height: auto;background-color: #FFFFFF;right: 5px;top: 50px;">
			<ul class="mui-list-unstyled jh-dropdown-list" style="margin-top:0px">
				<li id="EssentialOperation" style="display: none;height: 30px;line-height: 30px;">

				</li>
				<li id="StickyOperation" style="display: none;height: 30px;line-height: 30px;">

				</li>
				<li id="recommendOperation" style="display: none;height: 30px;line-height: 30px;">

				</li>
				<li id="editThread" style="display: none;height: 30px;line-height: 30px;">
					<a><i class="fa fa-edit" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp编辑</a>
				</li>
				<li id="editOperation" style="display: none;height: 30px;line-height: 30px;">
					<a><i class="fa fa-edit" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp编辑</a>
				</li>
				<li id="DeleteThread" style="display: none;padding-top: 3px;height: 30px;line-height: 30px;">
					<a><i class="fa fa-trash-o" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp删除</a>
				</li>
				<li id="report" style="height：30px;line-height: 30px;padding-top: 3px;">
					<a><i class="fa fa-exclamation-triangle" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp举报</a>
				</li>
			</ul>
		</div>

		<div class="mui-content">
			<div class="mui-content-padded">
				<div style="width: 100%;display: inline-block;">
					<div style="width: 15%;float: left;display: none;" id="Officialcertification">
						<img src="../img/122.png" srcset="../img/122@2x.png 2x,../img/122@3x.png 3x" style="margin-top: -10px;"/>
					</div>	
					<h4 class="jh-detail-title" id="threadTitle"  style="width: 85%;float: right;"></h4>
				</div>
				
				<div class="mui-list-inline text-muted">
					<img class="creator_img" id="userAvator" src="" onerror="defaultAvator(this);">
					<li id="Author"></li>
					<li id="DateCreated"></li>
					<li id="CategoryName" class="mui-pull-right" style="margin-top:3px;"></li>
				</div>
				<div class="detail_content" style="margin-top: 10px;">
					<p>
						<img id="imageAttachment" style="width: 100%;" src="" data-preview-src="" data-preview-group="1" />
					</p>
				</div>
				<div class="jh-activity-detail">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell">
							<ul class="mui-list-inline">
								<li><i class="fa fa-clock-o text-muted"></i></li>
								<li><span id="startDate"></span>—<span id="endDate"></span></li>
							</ul>
						</li>
						<li class="mui-table-view-cell" id="eventAddress">
							<ul class="mui-list-inline">
								<li style="width:5%;vertical-align:top;"><i class="fa fa-map-marker text-muted"></i> </li>
								<li style="width:90%;line-height:1.5;">
									<a><span id="completeAddress"></span><img id="mapimg" style="width: 20px;height: 20px;margin-left: 5px;" src="../img/map-img.png" /></a>
								</li>
							</ul>
						</li>
						<li class="mui-table-view-cell" id="userAvatorCell">
							<ul class="mui-list-inline">
								<li><img class="creator_img" id="author" src="" /></li>
								<li>
									<a id="userDisplayName"></a>
								</li>
							</ul>
						</li>
						<li class="mui-table-view-cell">
							报名截止时间：<span id="deadline"></span>
						</li>
						<li class="mui-table-view-cell">
							<ul class="mui-list-inline">
								<li>已报名 <span class="tn-theme-color" id="attendCount"></span>/<span id="memberCount"></span></li>
								<li class="mui-pull-right">浏览 <span id="hitTimes"></span></li>
							</ul>
						</li>
					</ul>
					<div class="mui-text-center tn-mt-10" style="padding-top: 10px;padding-bottom: 10px;">
						<button type="button" class="mui-btn mui-btn-primary" id="signUpOpt">我要报名</button>
						<a class="mui-pull-right" id="managerMember" style="display: none;">管理报名信息</a>
						<!--<button type="button" class="mui-btn jh-btn-gray" disabled="disabled">报名已截止</button>-->
					</div>
				</div>

				<div class="mui-bar mui-bar-tab jh-bar-comment">

				</div>
			</div>

		</div>
		<div class="jh-gray-bar" id="Stickygb"></div>
		<div id="slider" class="mui-slider">
			<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted jh-scroll-wrapper ">
				<div class="mui-scroll" id="SectionType" style="padding-right: 40px;">
					<a class="mui-control-item mui-active" href="#itemmobile" id=0>
						活动详情
					</a>
					<a class="mui-control-item" href="#item1mobile" id=1>
						已报名
					</a>
					<a class="mui-control-item" href="#item2mobile" id=2>
						用户讨论
					</a>
				</div>
			</div>

			<div class="mui-slider-group" id="sliderGroup">
				<div id="itemmobile" class="mui-slider-item mui-control-content mui-active" style="border: none;">
					<div class="detail_content">
						<p style="text-indent:2em;" class="mui-content-padded" id="eventDetail"></p>
						<div class="tn-file-list" id="attachments" style="display: none;"></div>
					</div>
				</div>
				<div id="item1mobile" class="mui-slider-item mui-control-content jh-activity-enroll" style="border: none;">
					<ul class="mui-table-view">
						<div class="mui-loading">
							<div class="mui-spinner"></div>
						</div>
					</ul>
				</div>

				<div id="item2mobile" class="mui-slider-item mui-control-content" style="border: none;">
					<div class="mui-loading">
						<div class="mui-spinner"></div>
					</div>
					<div class="mui-content mui-content-padded" id="commentList">
						<div id="commentArea">

						</div>

						<div class="mui-text-center" style="margin-top: 1rem;display: none;" id="morecomment">
							<span class="more-news">查看更多评论</span>
						</div>
					</div>

				</div>
			</div>
		</div>
		<div id="reportContainer" class="jh-medal-popover box mui-popover" style="background-color: #fff;display: none;padding: 0px !important;">
			<ul class="mui-table-view jh-word-vote" id="itemContainer">
				<span style="margin-left: 15px;">举报原因</span><span style="color: red;">*</span>
				<form class="mui-input-group" style="background-color: #fff;margin-bottom: 0px;">
					<div class="mui-input-row mui-radio">
						<span style="margin-left: 25px;">恶意灌水</span>
						<input name="style" type="radio" class="mui-pull-left" id="1"/>
					</div>
					<div class="mui-input-row mui-radio">
						<span style="margin-left: 25px;">淫秽色情</span>
						<input name="style" type="radio" class="mui-pull-left" id="2"/>
					</div>
					<div class="mui-input-row mui-radio">
						<span style="margin-left: 25px;">内容侵权</span>
						<input name="style" type="radio" class="mui-pull-left" id="3"/>
					</div>
					<div class="mui-input-row mui-radio">
						<span style="margin-left: 25px;">广告诈骗</span>
						<input name="style" type="radio" class="mui-pull-left" id="4"/>
					</div>
					<div class="mui-input-row mui-radio">
						<span style="margin-left: 25px;">其他</span>
						<input name="style" type="radio" class="mui-pull-left" id="99"/>
					</div>
				</form>
			</ul>
	    	<ul class="mui-table-view">
				<li style="padding-bottom: 0px; font-size: 16px;padding: 6px 10px;">
					<textarea id="reason" rows="2" placeholder="请输入举报原因"></textarea>
				</li>
			</ul>
			<p>
				<button class="Fbutton" style="border-radius: 0px 0px 0px 5px;color: #999;" id="cancelReport">取消</button>
				<button class="Fbutton" id="submitReport" style="color: #bf0a10;border-right: none;border-left:none;float: right;border-radius: 0px 0px 5px 0px;">确定</button>
			</p>
	    </div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/mui.zoom.js"></script>
		<script src="../js/mui.previewimage.js"></script>
		<script src="../js/service.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/comment.js"></script>
		<script src="../js/share.js"></script>
		<script src="../js/wxHelper.js"></script>
		<script src="../js/jweixin-1.2.0.js"></script>
		<script src="../js/jquery-2.1.0.js"></script>
		<script src="../js/openApp.js"></script>
		<script src="https://static.mlinks.cc/scripts/dist/mlink.min.js"></script>
		<script src="../js/cms.js"></script>
	</body>
	<script>
		if(!mui.os.plus) {
			creatBanner();
		}
		showLoading('', '', '#FFFFFF', '50px');

		if(!mui.os.wechat) {
			mui.previewImage();
		}
		if(mui.os.wechat) {
			initWx();
			wx.ready(function() {
				wx.checkJsApi({
					jsApiList: ['previewImage'], // 需要检测的JS接口列表，所有JS接口列表见附录2,
					success: function(res) {
						// 以键值对的形式返回，可用的api值true，不可用为false
						// 如：{"checkResult":{"chooseImage":true},"errMsg":"checkJsApi:ok"}
					}
				});
			});
			wx.error(function(res) {

			});
		}

		var author = document.getElementById("author");
		var userDisplayName = document.getElementById("userDisplayName");
		var userAvator = document.getElementById("userAvator");
		var userAvatorCell=document.getElementById("userAvatorCell");
		var imageAttachment = document.getElementById("imageAttachment");
		var threadOpt = document.getElementById("threadOpt");
		var startDate = document.getElementById("startDate");
		var endDate = document.getElementById("endDate");
		var completeAddress = document.getElementById("completeAddress");
		var deadline = document.getElementById("deadline");
		var attendCount = document.getElementById("attendCount");
		var memberCount = document.getElementById("memberCount");
		var hitTimes = document.getElementById("hitTimes");
		var editEvent = document.getElementById("editThread");
		var signUpOpt = document.getElementById("signUpOpt");
		var eventDetail = document.getElementById("eventDetail");
		var eventAddress = document.getElementById("eventAddress");
		var CategoryName = document.getElementById("CategoryName");
		var EssentialOperation = document.getElementById("EssentialOperation"); //精华
		var StickyOperation = document.getElementById("StickyOperation"); //置顶
		var DeleteThread = document.getElementById("DeleteThread"); //删除
		var userid = 0;
		//剩余报名人数
		var remainingEnrolment = 0;
		var address = '';
		var mapcoord = '';
		var SectionName = document.getElementById("SectionName");
		var IsSpecial=false;
		var IsSticky=false;
		var attachments = document.getElementById("attachments");
		var sectionId=0;

		var wximgEl = document.createElement("div");
		mui('.mui-scroll-wrapper').scroll();
		var deceleration = mui.os.ios ? 0.003 : 0.0009;
		mui('.mui-scroll-wrapper.mui-slider-indicator.mui-segmented-control').scroll({
			scrollY: false,
			scrollX: true,
			indicators: false,
			deceleration: deceleration,
			snap: '.mui-control-item'
		});
		mui.init();

		var threadId;
		var eventId;
		var currId = "";
		var subject;
		//B页面onload从服务器获取列表数据；
		window.onload = function() {
			//获取url中的targetId参数
			if(mui.os.plus) {
				mui.plusReady(function() {
					var self = plus.webview.currentWebview();
					eventId = self.AssociateId;
					currId = self.currId;
					threadId = self.threadId;
					getThreadDetail(threadId)
					getDetail(eventId)
					//关闭等待框
					plus.nativeUI.closeWaiting();
					//显示当前页面
					mui.currentWebview.show();
				});
			} else {
				eventId = getUrlParam('AssociateId');
				threadId = getUrlParam('threadId');
				getThreadDetail(threadId)
				getDetail(eventId)
			}
			if(!mui.os.plus) {
				initOpenApp('eventThreadDetail',threadId,{
					ThreadType:'1',
					AssociateId:eventId
				})
			}
			if(mui.os.wechat) {
				var currUrl = location.href.split('#')[0];
				weChatLogin(currUrl)
			}

		}
		function setPopHeight(idname) { 
			var height = document.documentElement.clientHeight || document.body.clientHeight;
			var popHeight = parseInt(window.getComputedStyle(document.getElementById(idname), null).minHeight);
			document.getElementById(idname).style.top = (height - popHeight)/2 + 'px';
		}
		document.getElementById('report').addEventListener('tap',function(){
			var islog = getlsData('isLogin');
			if(islog == 'true'){
				mui('#reportContainer').popover('toggle');
				setPopHeight('reportContainer');
			}else{
				login();
			}
		})	
		document.getElementById('cancelReport').addEventListener('tap',function(){
			mui('#reportContainer').popover('toggle');
		})
		document.getElementById('submitReport').addEventListener('tap',function(){
			var checked = false;
			for(var i = 0;i<document.getElementById('itemContainer').getElementsByTagName('input').length;i++){
				if(document.getElementById('itemContainer').getElementsByTagName('input')[i].checked == true){
					checked = true;
					var id = document.getElementById('itemContainer').getElementsByTagName('input')[i].id;
				}
			}
			if(checked == false){
				mui.toast("请选择举报原因");
				return;
			}
			var Description = TrimAll(document.getElementById('reason').value);
			EditReport(id,Description);
			mui('#reportContainer').popover('toggle');
		})
		function EditReport(id,Description){
			var params = {
				TenantTypeId:100011,
				Reason:id,
				Title:subject,
				Description:Description,
				ReportObjectId:threadId
			}
			postDatawithToken('User/EditReport',params, function(data) {
				if(data.Type == 1) {
					mui.toast(data.Data);					
				} else if(data.Type == 0) {
					//登录失败
					mui.toast("请登录后再进行操作");
					login();
					return;
				} else {
					//逻辑错误					
					mui.toast(data.Data);
					return;
				}
			}, function(data) {
				hideLoading()
			});
		}
		managerMember.addEventListener('tap', function() {
			var urlId = 'ManageEventMembers.html';
			var baseUrl = 'ManageEventMembers.html?eventId=' + eventId + '&remainingEnrolment=' + remainingEnrolment;
			mui.openWindow({
				url: baseUrl,
				id: urlId,
				show: {
					autoShow: true
				},
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				},
				extras: {
					eventId: eventId,
					remainingEnrolment:remainingEnrolment
				}
			})
		})
		if(mui.os.wechat) {
			mui("#eventDetail").on('tap', 'img', function(e) {
				var imgUrl = e.detail.target.currentSrc;
				var imgs = [];
				var imgels = wximgEl.querySelectorAll('img');
				for(var i = 0; i < imgels.length; i++) {
					imgs.push(imgels[i].src)
				}
				wx.previewImage({
					current: imgUrl,
					urls: imgs
				});
			})
		}
		
		function creatAttachment(data) {
			var fragment = document.createDocumentFragment();
			var div;
			for(var i = 0; i < data.length; i++) {
				var filename = data[i].FriendlyFileName;
				var type = filename.substring(filename.lastIndexOf('.') + 1);
				var typeIcon = '';
				var downloadUrl = '';
				switch(type) {
					case "wps":
					case "doc":
					case "docx":
						typeIcon = '<span class=" fa fa-file-word-o tn-blue-color"></span>';
						break;
					case "pps":
					case "pptx":
					case "ppt":
						typeIcon = '<span class="fa  fa-file-powerpoint-o tn-yellow-color"></span>';
						break;
					case "xls":
					case "xlsx":
						typeIcon = '<span class="fa  fa-file-excel-o tn-green-color"></span>';
						break;
					case "pdf":
						typeIcon = '<span class="fa  fa-file-pdf-o tn-green-color"></span>';
						break;
					case "txt":
						typeIcon = '<span class="fa  fa-file-text-o tn-green-color"></span>';
						break;
					case "jpg":
					case "png":
					case "bmp":
					case "gif":
						typeIcon = '<span class="fa  fa-file-image-o tn-green-color"></span>';
						break;
					case "flv":
					case "rmvb":
					case "mp4":
					case "3gp":
					case "mpeg":
					case "wmv":
					case "mov":
					case "avi":
					case "asf":
						typeIcon = '<span class="fa  fa-file-video-o tn-blue-color"></span>';
						break;
					case "zip":
					case "rar":
						typeIcon = '<span class="fa  fa-file-zip-o tn-red-color"></span>';
						break;
					case "mp3":
					case "wav":
					case "rm":
						typeIcon = '<span class="fa  fa-file-audio-o tn-red-color"></span>';
						break;
					default:
						typeIcon = '<span class="fa  fa-file-o tn-black-color"></span>'
						break;
				}

				div = document.createElement('div');
				div.className = 'mui-row';
				div.innerHTML = '<div class="mui-col-xs-1">' +
					''+typeIcon+''+
					'</div>' +
					'<div class="mui-col-xs-7 mui-ellipsis">' + data[i].FriendlyFileName.substring(0, 15) + '</div>' +
					'<div class="mui-col-xs-2 text-muted mui-text-right">' + data[i].Size + '</div>' +
					'<div class="mui-col-xs-2 mui-text-right">' +
					'<a id=' + data[i].Url + ' title=' + data[i].FriendlyFileName + '>下载</a>' +
					'</div>';
				fragment.appendChild(div);
			}
			return fragment;
		};
		mui("#attachments").on('tap', 'a', function(e) {
			if(mui.os.plus) {
				startDownloadTask(this.getAttribute('id'))
			} else {
				download(this.getAttribute('id'), this.getAttribute('title'), location.href.split('#')[0])
			}

		})
		
		userAvatorCell.addEventListener('tap', function() {
			var baseUrl = 'userHomepage.html';
			var url = baseUrl + '?userId=' + userid;
			mui.openWindow({
				url: url,
				id: 'userHomepage.html',
				show: {
					autoShow: false
				},
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				},
				extras: {
					userId: userid
				}
			})
		})
		userAvator.addEventListener('tap', function() {
			var baseUrl = 'userHomepage.html';
			var url = baseUrl + '?userId=' + userid;
			mui.openWindow({
				url: url,
				id: 'userHomepage.html',
				show: {
					autoShow: false
				},
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				},
				extras: {
					userId: userid
				}
			})
		})

		mui("#commentArea").on('tap', '.creator_img_comment', function(e) {
			var userid = this.getAttribute('id');
			var baseUrl = 'userHomepage.html';
			var url = baseUrl + '?userId=' + userid;
			mui.openWindow({
				url: url,
				id: 'userHomepage.html',
				show: {
					autoShow: false
				},
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				},
				extras: {
					userId: userid
				}
			})

		})

		mui("#item1mobile").on('tap', '.mui-table-view-cell', function(e) {
			var userid = this.getAttribute('id');
			var baseUrl = 'userHomepage.html';
			var url = baseUrl + '?userId=' + userid;
			mui.openWindow({
				url: url,
				id: 'userHomepage.html',
				show: {
					autoShow: false
				},
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				},
				extras: {
					userId: userid
				}
			})

		})
		signUpOpt.addEventListener('tap', function() {
			var islog = getlsData('isLogin');
			if(islog == 'true') {
				var baseUrl = 'eventSignUp.html?eventId=' + eventId + '&remainingEnrolment=' + remainingEnrolment+'&memberId='+0;
				mui.openWindow({
					url: baseUrl,
					id: 'eventSignUp.html',
					show: {
						autoShow: true
					},
					waiting: {
						options: {
							loading: {
								height: '35px'
							}
						}
					},
					extras: {
						eventId: eventId,
						remainingEnrolment: remainingEnrolment,
						memberId:0
					}
				})
			} else {
				login();
			}
		})

		threadOpt.addEventListener('tap', function() {
			mui('#popover').popover('toggle');
		})

		function essentialOperation(id) {
			showLoading();
			postDatawithToken('Post/EssentialOperation?threadId=' + id, {}, function(data) {
				hideLoading();
				if(data.Type == 1) {
					mui.toast(data.Data);
					mui('#popover').popover('hide');
					IsSpecial=!IsSpecial;
					changeStatus(IsSpecial,IsSticky)
				} else if(data.Type == 0) {
					//登录失败
					mui.toast("请登录后再进行操作");
					login();
					return;
				} else {
					//逻辑错误
					mui.toast(data.Data);
					return;
				}
			}, function(err) {
				setErr('','',false)
			})
		}

		function stickyOperation(id) {
			showLoading();
			postDatawithToken('Post/StickyOperation?threadId=' + id, {}, function(data) {
				hideLoading();
				if(data.Type == 1) {
					mui.toast(data.Data);
					mui('#popover').popover('hide');
					IsSticky=!IsSticky;
					changeStatus(IsSpecial,IsSticky)
				} else if(data.Type == 0) {
					//登录失败
					mui.toast("请登录后再进行操作");
					login();
					return;
				} else {
					//逻辑错误
					mui.toast(data.Data);
					return;
				}
			}, function(err) {
				setErr('','',false)
			})
		}
		function UpdateEvent(id,sectionId,threadId){
			var urlId = 'creatEvent.html';
			var baseUrl = 'creatEvent.html?eventId=' + id+'&sectionId='+sectionId+'&threadId='+threadId;
			mui.openWindow({
				url: baseUrl,
				id: urlId,
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				},
				extras: {
					eventId: id,
					sectionId:sectionId,
					threadId:threadId
				}
			})
		}


		function deleteThread(id) {
			showLoading();
			postDatawithToken('Post/DeleteThread?threadId=' + id, {}, function(data) {
				hideLoading();
				if(data.Type == 1) {
					mui.toast(data.Data);
					if(mui.os.plus) {
						mui('#popover').popover('hide');
						var wobj = plus.webview.getWebviewById(currId);
						wobj.reload(true);
						setTimeout(function() {
							mui.back();
						}, 500)
					} else {
						mui.back();
					}

				} else if(data.Type == 0) {
					//登录失败
					mui.toast("请登录后再进行操作");
					login();
					return;
				} else {
					//逻辑错误
					mui.toast(data.Data);
					return;
				}
			}, function(err) {
				setErr('','',false)
			})
		}

		function btnOpt(text) {
			signUpOpt.innerHTML = text;
			signUpOpt.style.backgroundColor = '#999999';
			signUpOpt.style.borderColor = '#999999';
			signUpOpt.setAttribute("disabled", "disabled");
			//signUpOpt.removeAttribute("disabled");
		}
		document.getElementById('item1mobile').addEventListener('scrollbottom', function() {
			getMemberByEventId(true, eventId)
		})
		function changeStatus(isSpecial,isSticky){
			EssentialOperation.innerHTML=isSpecial?'<a><i class="fa fa-star-o" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp取消加精</a>':'<a><i class="fa fa-star" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp加精</a>';
			if(isSticky) {
				//置顶
				document.getElementById("threadtype").innerHTML = '置顶 ·  ';
				StickyOperation.innerHTML = '<a><i class="fa fa-chevron-down" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp取消置顶</a>';
			} else {
				//非置顶
				document.getElementById("threadtype").innerHTML = '';
				StickyOperation.innerHTML = '<a><i class="fa fa-chevron-up" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp置顶</a>';
			}
			
		}
		function getThreadDetail(id) {
			showLoading('', '', '#FFFFFF', '50px');
			getDatawithToken('Post/ThreadDetail', {
				threadId: id
			}, function(data) {
				hideLoading();
				hideErr();
				if(data.Type == 1) {
					if(data.Data && typeof(data.Data) == 'object') {
						var data = data.Data;
						subject = data.Subject;
						setIdandType(threadId, 'Thread', data.CommentCount)
						ii = data.Comments.length;
						userid = data.UserId;
						userAvator.src = data.Avatar == "" ? "../img/avatar.jpg" : getImgUrl(data.Avatar);
						document.getElementById('editThread').style.display = data.IsAllowMobileEdit == true ? 　'block' : 'none';
						document.getElementById('editThread').title = data.SectionId;
						SectionName.innerHTML = data.SectionName.substring(0, 15);
						SectionName.id = data.SectionId;
						sectionId=data.SectionId;
						threadTitle.innerHTML = '<span id="threadType" class="theme-color"><span id="threadtype"></span></span>' + data.Subject;
						threadTitle.style.width='100%';
						mui.each(data.SpecialTypes,function(index, item){
							if(item.Name=='官方认证'){
								threadTitle.style.width='85%';
								document.getElementById("Officialcertification").style.display=''
							}
						})
						
						changeStatus(data.IsSpecial,data.IsSticky)
						Author.innerText = data.Author.substring(0, 8);
						DateCreated.innerText = data.DateCreated;
						if(data.CategoryName.length > 0) {
							CategoryName.innerHTML = '<i class="fa fa-list-ul" aria-hidden="true">&nbsp;' + data.CategoryName + '</i>'
						}
						if(data.Comments && data.Comments.length < 5) {
							morecomment.style.display = 'none';
						} else {
							morecomment.style.display = 'block';
						}
						var idName = 'item2mobile';
						var fragment = document.getElementById(idName);
						if(fragment.querySelector('.mui-loading')) {
							fragment.removeChild(fragment.querySelector('.mui-loading'));
						}
						if(data.Comments.length > 0) {
							commentArea.appendChild(createComFragment(data.Comments));
							document.getElementById("slider").style.height = (document.getElementById("commentArea").offsetHeight + 180) + 'px';
						} else {
							var errForList = showErrForList('暂无数据', '', '0', idName);
							if(errForList) {
								fragment.appendChild(showErrForList('暂无数据', '', '0', idName))
							}

						}
						setLastBoard();
						setShareInfo(getlsData('currUrl'), data.Subject, data.Subject);
						com.isFavorited = data.IsFavorited;
						favorThread(data.IsFavorited);
						EssentialOperation.style.display = (data.IsManage) ? 'inherit' : 'none';
						StickyOperation.style.display = (data.IsManage) ? 'inherit' : 'none';
						if(data.IsAllowMobileEdit){
							if(data.IsManage||data.CanDelete){
								editEvent.style.display='inherit'
							}else{
								editEvent.style.display='none'
							}
						}else{
							editEvent.style.display='none'
						}
						DeleteThread.style.display = (data.CanDelete) ? 'inherit' : 'none';
						var islog = getlsData('isLogin');
//						threadOpt.style.display = (islog == 'true') ? 'inherit' : 'none';
//						if(!data.IsManage && !data.CanDelete) {
//							threadOpt.style.display = 'none';
//						}
					} else {
						threadOpt.style.display = 'none';
						showErr(data.Data, '', '#FFFFFF', '50px')
						mui.toast(data.Data);
					}
				} else if(data.Type == 0) {
					//登录失败
					mui.toast("请登录后再进行操作");
					login();
					return;
				} else {
					//逻辑错误
					threadOpt.style.display = 'none';
					showErr(data.Data, '', '#FFFFFF', '50px')
					mui.toast(data.Data);
					return;
				}
			}, function(err) {
				setErr()
			})
		}

		function getDetail(id) {
			showLoading('', '', '#FFFFFF', '50px');
			getDatawithToken('Event/EventDetail', {
				eventId: id
			}, function(data) {
				hideLoading();
				hideErr();
				if(data.Type == 1) {
					if(data.Data && typeof(data.Data) == 'object') {
						var data = data.Data;
						userid = data.UserId;
						author.src = data.Avatar == "" ? "../img/avatar.jpg" : getImgUrl(data.Avatar);
						userDisplayName.innerHTML = data.UserDisplayName;
						imageAttachment.src = data.ImageAttachment == "" ? "../img/slider-1.jpg" : getImgUrl(data.ImageAttachment);
						startDate.innerHTML = data.StartDate;
						endDate.innerHTML = data.EndDate;
						completeAddress.innerHTML = data.CompleteAddress == "" ? '暂无地址' : data.CompleteAddress;
						if(completeAddress.innerHTML=='暂无地址'){
							document.getElementById("mapimg").style.display='none'
						}
						address = data.CompleteAddress;
						mapcoord = data.MapCoord;
						deadline.innerHTML = data.Deadline;
						attendCount.innerHTML = data.AttendCount;
						memberCount.innerHTML = data.MemberCount;
						hitTimes.innerHTML = data.HitTimes;
						remainingEnrolment = data.MemberCount - data.AttendCount;
						if(data.MemberCount==0){
							memberCount.innerHTML ='无限制';
							remainingEnrolment=99999
						}
						if(data.MemberCount!=0&&(data.AttendCount >= data.MemberCount)) {
							btnOpt('报名人数已满')
						};
						if(data.IsEnded) {
							btnOpt('报名已结束')
						};
						if(data.IsAttend) {
							btnOpt('已报名')
						};
						var oldDate = new Date(data.Deadline);
						var nowDate = new Date();
						if(nowDate > oldDate) {
							btnOpt('报名已截止')
						};
						eventDetail.innerHTML = '';
						eventDetail.innerHTML = getBodyImgUrl(data.Body);
						if(data.Attachments && data.Attachments.length > 0) {
							attachments.style.display = 'block';
							attachments.appendChild(creatAttachment(data.Attachments));
						} else {
							attachments.style.display = 'none';
						}
						wximgEl.innerHTML = data.Body;
						var item = document.getElementById("itemmobile");
						document.getElementById("slider").style.height = 'auto';
						item.style.paddingBottom = '50px';
						if(data.CompleteAddress == null||data.CompleteAddress ==""||mapcoord == "" || mapcoord == null){
							completeAddress.style.color='#000000';
							document.getElementById("mapimg").style.display='none'
						}
					} else {
						//threadOpt.style.display = 'none';
						showErr(data.Data, '', '#FFFFFF', '50px')
						mui.toast(data.Data);
					}
				} else if(data.Type == 0) {
					//登录失败
					mui.toast("请登录后再进行操作");
					login();
					return;
				} else {
					//逻辑错误
					//threadOpt.style.display = 'none';
					showErr(data.Data, '', '#FFFFFF', '50px')
					mui.toast(data.Data);
					return;
				}
			}, function(err) {
				setErr()
			})
		}

		var creatMemberElement = function(data, id) {
			var fragment = document.getElementById(id);
			var cfragment = fragment.firstElementChild;
			var finel = cfragment;
			for(var i = 0; i < data.length; i++) {
				if(data[i].ApprovalStatus == 20 || data[i].ApprovalStatus == 30) { //"ApprovalStatus:审核状态：10=未通过，20=待审核，30=需再审核，40=通过"
					var ApprovalStatus = data[i].ApprovalStatus == 20 ? '<span style="color: #FF9900;">待审核</span>' : '<span style="color: #FF9900;">需再审核</span>'
				}
				if(data[i].ApprovalStatus == 10) {
					var ApprovalStatus = '<span style="color: #FF0000;">审核未通过</span>'
				}
				if(data[i].ApprovalStatus == 40) {
					var ApprovalStatus = '<span style="color: #008000;">审核通过</span>'
				}
				var li;
				var userAvator = data[i].Avatar == "" ? "../img/avatar.jpg" : getImgUrl(data[i].Avatar);
				li = document.createElement('li');
				li.className = 'mui-table-view-cell';
				li.style.padding = '10px';
				li.id = data[i].UserId;
				li.innerHTML = '<ul class="mui-list-inline">' +
					'<li><img class="creator_img_comment " src="' + userAvator + '" /></li>' +
					'<li>' + data[i].UserName.substring(0,8) + '</li>' +
					'<li style="padding-left:10px">' + data[i].DateCreated + '</li>' +
					'<li class="mui-pull-right">' + ApprovalStatus + '</li>' +
					'</ul>';
				finel.appendChild(li);
			}
		};

		var page = 1;

		function getMemberByEventId(more, id) {
			if(!more) {
				showLoading('', '', '#FFFFFF', '100px', '1');
			}
			var idName = 'item1mobile';
			var fragment = document.getElementById(idName);
			var cfragment = fragment.firstElementChild;
			var finel = cfragment;
			if(more) {
				page++;
			} else {
				finel.innerHTML = '';
				page = 1;
			}
			var params = {
				eventId: id,
				pageIndex: page
			};
			getData('Event/GetMemberByEventId', params, function(data) {
				hideLoading()
				hideErr()
				if(data.Type == 1) {
					if(data.Data && typeof(data.Data) == 'object') {
						hideErrForList('', idName);
						if(data.Data.length == 0) {
							if(!more) {
								var errForList = showErrForList('暂无人员', '', '10px', idName);
								if(errForList) {
									fragment.appendChild(showErrForList('暂无人员', '', '10px', idName))
								}
							}
						}
						creatMemberElement(data.Data, 'item1mobile');
						var item = document.getElementById("item" + 1 + "mobile");
						document.getElementById("slider").style.height = (item.offsetHeight + 150) + 'px';
					} else {
						if(!more) {
							var errForList = showErrForList('暂无更多人员', '', '', idName);
							if(errForList) {
								fragment.appendChild(showErrForList('暂无更多人员', '', '', idName))
							}
						}
					}
				} else {
					hideLoading();
					//逻辑错误
					var errForList = showErrForList(data.Data, '', '', idName);
					if(errForList) {
						fragment.appendChild(showErrForList(data.Data, '', '', idName))
					}
					return;
				}
			}, function(err) {
				setErr()
			})
		}

		function getComments(id) {
			var params = {
				eventId: id,
				pageSize: '10',
				pageIndex: '1'
			};
			var idName = 'item2mobile';
			var fragment = document.getElementById(idName);
			getData('Event/GetCommentByEventId', params, function(data) {
				hideLoading();
				hideErr();
				if(fragment.querySelector('.mui-loading')) {
					fragment.removeChild(fragment.querySelector('.mui-loading'));
				}
				if(data.Type == 1) {
					if(data.Data && typeof(data.Data) == 'object') {
						hideErrForList('', idName);
						if(data.Data.Comments.length == 0) {
							var errForList = showErrForList('暂无数据', '', '0', idName);
							if(errForList) {
								fragment.appendChild(showErrForList('暂无数据', '', '0', idName))
							}
						}
						if(data.Data.Comments && data.Data.Comments.length < 5) {
							morecomment.style.display = 'none';
						} else {
							morecomment.style.display = 'block';
						}
						document.getElementById("commentArea").appendChild(createComFragment(data.Data.Comments));
						var item = document.getElementById("item" + 1 + "mobile");
						document.getElementById("slider").style.height = (document.getElementById("commentArea").offsetHeight + 180) + 'px';
						setLastBoard();
					} else {
						if(!more) {
							var errForList = showErrForList('暂无更多数据', '', '', idName);
							if(errForList) {
								fragment.appendChild(showErrForList('暂无更多数据', '', '', idName))
							}
						}
					}
				} else {
					hideLoading();
					//逻辑错误
					var errForList = showErrForList(data.Data, '', '', idName);
					if(errForList) {
						fragment.appendChild(showErrForList(data.Data, '', '', idName))
					}
					return;
				}
			}, function(err) {
				setErr()
			})

		}
		mui('.mui-slider').slider().setStopped(true);
		mui(".mui-slider").on('tap', '.mui-control-item', function(e) {
			var index = this.getAttribute('id');
			var item = document.getElementById("item" + index + "mobile");

			if(index == 0) {
				var itemmobile = document.getElementById("itemmobile");
			} else {
				var itemmobile = document.getElementById("item" + index + "mobile");
			}

			document.getElementById("slider").style.height = (itemmobile.offsetHeight + 150) + 'px';
			if(index != 0) {
				if(item.querySelector('.mui-loading')) {
					if(index == 1) {
						getMemberByEventId(false, eventId)
					} else {
						//getComments(eventId)
					}
				}
			}

		})
		mui(".mui-list-unstyled").on('tap', 'li', function(e) {
			if(mui.os.plus) {
				mui('#popover').popover('toggle');
			}
			switch(this.getAttribute('id')) {
				case "EssentialOperation":
					//加精or取消加精
					essentialOperation(threadId)
					break;
				case "StickyOperation":
					//置顶or取消置顶
					stickyOperation(threadId)
					break;
				case "editThread":
					UpdateEvent(eventId,sectionId,threadId)
					break;
				case "DeleteThread":
					//删除
					mui('#popover').popover('toggle');
					var btnArray = ['取消', '确定'];
					mui.confirm('确认删除？', '贴子', btnArray, function(e) {
						if(e.index == 1) {
							deleteThread(threadId)
						}
					});
					break;
				default:
					break;
			}

		})
		eventAddress.addEventListener('tap', function() {
			if(mapcoord == "" || mapcoord == null) {
				return
			} else {
				if(mui.os.plus) {
					address = encodeURIComponent(address);
					mapcoord = encodeURIComponent(mapcoord)
					var baseUrl = 'eventAddressMap.html?address=' + address + '&mapcoord=' + mapcoord;
					mui.openWindow({
						url: baseUrl,
						id: 'eventAddressMap.html',
						show: {
							autoShow: true
						},
						waiting: {
							options: {
								loading: {
									height: '35px'
								}
							}
						},
						extras: {
							address: address,
							mapcoord: mapcoord
						}
					})
				} else {
					var lng = mapcoord.substring(0, mapcoord.indexOf(','));
					var lat = mapcoord.substring(mapcoord.indexOf(',') + 1);
					var MapCoord = lat + ',' + lng;
					location.href = "http://api.map.baidu.com/marker?location=" + MapCoord + "&title=活动地点&content=" + address + "&output=html"
				}
			}
})
		SectionName.addEventListener('tap', function() {
			var sectionId = this.getAttribute("id");
			var baseUrl = 'postDetail.html';
			var url = mui.os.plus ? baseUrl : baseUrl + '?sectionId=' + sectionId;
			mui.openWindow({
				url: url,
				id: 'postDetail.html',
				show: {
					autoShow: false
				},
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				},
				extras: {
					sectionId: sectionId
				}
			})

		})
	</script>

</html>