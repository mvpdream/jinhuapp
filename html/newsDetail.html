<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--通用样式-->
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../css/icons-extra.css" />
		<link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css" />
		<link rel="stylesheet" href="../css/jinhu.css">
		
	</head>
	<style>
		#reportContainer{
			position: fixed;
			margin-left: 5%;
			min-height: 375px;
			background-color: #ffffff;
		}
		#reportContainer button{
			width: 50%;
		    height: 40px;
		    line-height: 24px;
		    border-right: 1px solid #eff2f9;
		    border-top: none;
		    border-bottom: none;
		    text-align: center;
		    margin-right: 0px;
		}
		#reportContainer p {
			margin-bottom: 0px;
		    height: 40px;
		    line-height: 40px;
		    width: 100%;
		    border-top: 1px solid #eff2f9;
		}
		#reportContainer ul{
			background-color: #fff;
			margin: 5px 5px;
			padding: 3px;
		}
		#popView_share1 a span {
			margin: 15px
		}
		.jh-dropdown-list i {
		    font-size: 22px;
		    width: 22px;
		}
		.jh-dropdown-list{
			border: none;
			padding: 15px 0px 0px 26px;
		}
		#new_detail img{
			width: 100%;
		}
	</style>

	<body style="background-color: #fff;">

		<header class="mui-bar mui-bar-nav">
			<button class="mui-action-back mui-btn mui-btn-link mui-btn-nav mui-pull-left" style="color:#333333">
				<span class="mui-icon mui-icon-left-nav"></span><span id="NewsName"></span>
			</button>
			<a id="newsOpt"  class="mui-icon mui-icon-bars mui-pull-right" style="color: #333;"></a>
		</header>
		<div id="popover" class="mui-popover" style="width: 130px;position:fixed;height: auto;background-color: #FFFFFF;right: 5px;top: 50px;">
			<ul class="mui-list-unstyled jh-dropdown-list" style="margin-top:0px">		
				<li id="editNews" style="height: 30px;display: none;line-height: 30px;">
					<a><i class="fa fa-edit" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp编辑</a>
				</li>
				<li id="DeleteNews" style="height：30px;line-height: 30px;padding-top: 3px;">
					<a><i class="fa fa-trash-o" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp删除</a>
				</li>
				<li id="report" style="height：30px;line-height: 30px;padding-top: 3px;">
					<a><i class="fa fa-exclamation-triangle" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp举报</a>
				</li>
			</ul>
		</div>

		<div class="mui-content jh-detail-content">
			<div class="mui-content-padded">
				<h4 class="jh-detail-title" id="newsTitle"></h4>
				<ul class="mui-list-inline text-muted">
					<img class="creator_img" id="userAvator" src="../img/avatar.jpg">
					<li id="Author"></li>
					<li id="DateCreated"></li>
					<li class="mui-pull-right" style="margin-top:3px;"><i class="fa fa-eye" aria-hidden="true">&nbsp;<span id="hittimes"></span></i></li>

				</ul>
				<div class="detail_content" id="new_detail" style="word-break: break-all;">

				</div>
				<div class="tn-file-list" id="attachments" style="display: none;padding-top: 0;">

			</div>
			
			
			
			<div class="jh-hot-label" id="tagsContainer" style="display: none;">
				<span>
					<i class="fa fa-tags text-muted"  aria-hidden="true"></i>
				</span>
				<span id="tags">
					
				</span>
				
			</div>

			<div class="comment mui-text-center" id="supportArea">
				<a style="padding-top: 0px;">
					<span id="support" style="line-height: 47px;" class="mui-icon-extra mui-icon-extra-like">
				</a>
				<span style="font-size: 0.9rem;padding-left: 5px;">
					<span  id="attitudeCount">10</span>
				</span>
			</div>
			</div>

			<div class="jh-title-container" id="jgb">
					<div class="home_content_title">评论列表</div>
			</div>
			<div class="loadingItem" id="noCom" style="padding-top: 20px;padding-bottom: 20px;color: #CCCCCC;display: none;">
				<i class="fa fa-info-circle fa-2x" style="vertical-align:middle;"></i>
				<span id="loadmsgtext" style="vertical-align:middle;padding-left: 5px;"> 暂无评论</span>
			</div>
			<div class="mui-content mui-content-padded" id="commentList" style="display: none">
						<div id="commentArea">
							
						</div>
						
			<div class="mui-text-center" style="margin-top: 1rem;display: none;" id="morecomment">
					<span class="more-news">查看更多评论</span>
			</div>    
		</div>

		<div class="mui-bar mui-bar-tab jh-bar-comment"  id="commentBar">
			
		</div>
		
		<div id="reportContainer" class="jh-medal-popover box mui-popover" style="background-color: #fff;display: none;padding: 0px !important;">
			<ul class="mui-table-view jh-word-vote" id="itemContainer">
				<span style="margin-left: 15px;">举报原因</span><span style="color: red;">*</span>
				<form class="mui-input-group" style="background-color: #fff;margin-bottom: 0px;">
					<div class="mui-input-row mui-radio">
						<span style="margin-left: 25px;">恶意灌水</span>
						<input name="style" type="radio" class="mui-pull-left" id="1"/>
					</div>
					<div class="mui-input-row mui-radio">
						<span style="margin-left: 25px;">淫秽色情</span>
						<input name="style" type="radio" class="mui-pull-left" id="2"/>
					</div>
					<div class="mui-input-row mui-radio">
						<span style="margin-left: 25px;">内容侵权</span>
						<input name="style" type="radio" class="mui-pull-left" id="3"/>
					</div>
					<div class="mui-input-row mui-radio">
						<span style="margin-left: 25px;">广告诈骗</span>
						<input name="style" type="radio" class="mui-pull-left" id="4"/>
					</div>
					<div class="mui-input-row mui-radio">
						<span style="margin-left: 25px;">其他</span>
						<input name="style" type="radio" class="mui-pull-left" id="99"/>
					</div>
				</form>
			</ul>
	    	<ul class="mui-table-view">
				<li style="padding-bottom: 0px; font-size: 16px;padding: 6px 10px;">
					<textarea id="reason" rows="2" placeholder="请输入举报原因"></textarea>
				</li>
			</ul>
			<p>
				<button class="Fbutton" style="border-radius: 0px 0px 0px 5px;color: #999;" id="cancelReport">取消</button>
				<button class="Fbutton" id="submitReport" style="color: #bf0a10;border-right: none;border-left:none;float: right;border-radius: 0px 0px 5px 0px;">确定</button>
			</p>
	    </div>
	</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/mui.zoom.js"></script>
		<script src="../js/mui.previewimage.js"></script>
		<script src="../js/service.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/comment.js"></script>
		<script src="../js/share.js"></script>
		<script src="../js/wxHelper.js"></script>
		<script src="../js/jweixin-1.2.0.js"></script>
		<script src="../js/jquery-2.1.0.js"></script>
		<script src="../js/openApp.js"></script>
		<script src="https://static.mlinks.cc/scripts/dist/mlink.min.js"></script>
		<script src="../js/attachment.js"></script>
	</body>
	<script>
		
		if(!mui.os.plus) {
			creatBanner();
		}
		showLoading('', '', '#FFFFFF', '50px');
		mui.init();
		if(!mui.os.wechat) {
			mui.previewImage();
		}
		if(mui.os.wechat) {
			initWx();
			wx.ready(function() {
				wx.checkJsApi({
					jsApiList: ['previewImage','onMenuShareAppMessage'], // 需要检测的JS接口列表，所有JS接口列表见附录2,
					success: function(res) {
						//alert(JSON.stringify(res))
						// 以键值对的形式返回，可用的api值true，不可用为false
					}
				});
			});
			wx.error(function(res) {
				//alert(JSON.stringify(res))
			});
		}

		//window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"32"},"share":{},"image":{"viewList":["qzone","tsina","weixin"],"viewText":"分享到：","viewSize":"32"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
		var height = document.documentElement.clientHeight || document.body.clientHeight;
		document.querySelector('.jh-detail-content').style.minHeight = height + 'px';
		var NewsName = document.getElementById("NewsName");
		var newsTitle = document.getElementById("newsTitle");
		var Author = document.getElementById("Author");
		var DateCreated = document.getElementById("DateCreated");
		
		var newsOpt = document.getElementById('newsOpt');
		var commentArea = document.getElementById("commentArea");
		var new_detail = document.getElementById("new_detail");
		var userAvator = document.getElementById("userAvator");
		var supportArea = document.getElementById("supportArea");
		var tags = document.getElementById("tags");
		var tagsContainer = document.getElementById("tagsContainer");
		var hittimes = document.getElementById("hittimes");
		var attitudeCount = document.getElementById("attitudeCount");

		var DownloadProgress = document.getElementById("downloadProgress");
		var attachments = document.getElementById("attachments");
		var userid = 0;
		var attitudeNum = 0;
		var wximgEl = document.createElement("div");

		if(mui.os.wechat) {
			mui("#new_detail").on('tap', 'img', function(e) {
				var imgUrl = e.detail.target.currentSrc;
				var imgs = [];
				var imgels = wximgEl.querySelectorAll('img');
				for(var i = 0; i < imgels.length; i++) {
					imgs.push(imgels[i].src)
				}
				wx.previewImage({
					current: imgUrl,
					urls: imgs
				});
			})
		}

		var contentItemId;
		var currId = "";
		var backType;
		var tabIndex=0;
		var title;
		window.onload = function() {
			//获取url中的targetId参数
			if(mui.os.plus) {
				mui.plusReady(function() {
					//关闭等待框
					var self = plus.webview.currentWebview();
					contentItemId = self.ContentItemId;
					backType = self.type;
					tabIndex=self.tabIndex;
					getDetail(contentItemId)
					plus.nativeUI.closeWaiting();
					//显示当前页面
					mui.currentWebview.show();
				});
			} else {
				contentItemId = getUrlParam('ContentItemId');
				backType = getUrlParam('type');
				//document.getElementById("GoToAppButton").href='jhapp://newDetail.html?ContentItemId='+contentItemId;
				getDetail(contentItemId)
			}
			if(!mui.os.plus) {
				initOpenApp('newsDetail', contentItemId)
			}
			if(mui.os.wechat) {
				var currUrl = location.href.split('#')[0];
				weChatLogin(currUrl)

			}

		}
		function setPopHeight(idname) { 
			var height = document.documentElement.clientHeight || document.body.clientHeight;
			var popHeight = parseInt(window.getComputedStyle(document.getElementById(idname), null).minHeight);
			document.getElementById(idname).style.top = (height - popHeight)/2 + 'px';
		}
		document.getElementById('report').addEventListener('tap',function(){
			var islog = getlsData('isLogin');
			if(islog == 'true'){
				mui('#reportContainer').popover('toggle');
				setPopHeight('reportContainer');
			}else{
				login();
			}
		})	
		document.getElementById('cancelReport').addEventListener('tap',function(){
			mui('#reportContainer').popover('toggle');
		})
		document.getElementById('submitReport').addEventListener('tap',function(){
			var checked = false;
			for(var i = 0;i<document.getElementById('itemContainer').getElementsByTagName('input').length;i++){
				if(document.getElementById('itemContainer').getElementsByTagName('input')[i].checked == true){
					checked = true;
					var id = document.getElementById('itemContainer').getElementsByTagName('input')[i].id;
				}
			}
			if(checked == false){
				mui.toast("请选择举报原因");
				return;
			}
			var Description = TrimAll(document.getElementById('reason').value);
			EditReport(id,Description);
			mui('#reportContainer').popover('toggle');
		})
		function EditReport(id,Description){
			var params = {
				TenantTypeId:100011,
				Reason:id,
				Title:title,
				Description:Description,
				ReportObjectId:contentItemId
			}
			postDatawithToken('User/EditReport',params, function(data) {
				if(data.Type == 1) {
					mui.toast(data.Data);					
				} else if(data.Type == 0) {
					//登录失败
					mui.toast("请登录后再进行操作");
					login();
					return;
				} else {
					//逻辑错误					
					mui.toast(data.Data);
					return;
				}
			}, function(data) {
				hideLoading()
			});
		}
		userAvator.addEventListener('tap', function() {
			var baseUrl = 'userHomepage.html';
			var url = baseUrl + '?userId=' + userid;
			mui.openWindow({
				url: url,
				id: 'userHomepage.html',
				show: {
					autoShow: false
				},
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				},
				extras: {
					userId: userid
				}
			})
		})

		function createTags(data) {
			var fragment = document.createDocumentFragment();
			var a;
			for(var i = 0; i < data.length; i++) {
				a = document.createElement('a');
				a.style.marginLeft = (i == 0) ? '0' : '10px'
				a.id = data[i].Id;
				a.innerHTML = '<span class="label label-default mui-ellipsis-1">' + data[i].TagName + '</span>';
				fragment.appendChild(a);
			}
			return fragment;
		};
		var isFavorited = false;
		var isAttitude = false;
		var supportnum = 0;
		
		newsOpt.addEventListener('tap', function() {
			mui('#popover').popover('toggle');			
		})
	mui("#popover").on('tap', '#editNews', function(e) {
		mui('#popover').popover('hide');
			var baseUrl = 'editNew.html';
			var url = mui.os.plus ? baseUrl : baseUrl + '?contentItemId=' + contentItemId;
			mui.openWindow({
				url: url,
				id: 'editNew.html',
				show: {
					autoShow: true
				},				
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				},
				extras: {
					contentItemId: contentItemId
				}
			})
	})
	mui("#popover").on('tap', '#DeleteNews', function(e) {
		var btnArray = ['是', '否'];
				mui.confirm('是否删除该资讯？', '', btnArray, function(e) {
					if(e.index == 0) {
						postDatawithToken('CMS/DeleteContentItem?contentItemId=' + contentItemId, {}, function(data) {						
						if(data.Type == 1) {
							if(mui.os.plus) {
							mui('#popover').popover('hide');
							mui.toast(data.Data);
							var index=tabIndex.toString();
							var wobj = plus.webview.getWebviewById(backType);
							wobj.evalJS("getsectionType('"+index+"')")
							setTimeout(function() { mui.back(); }, 500)							    
						} else {
							mui.toast(data.Data);
							setTimeout(function() { mui.back(); }, 500)							
						}
						} else if(data.Type == 0) {
							//登录失败
							mui.toast("请登录后再进行操作");
							login();
							return;
						} else {
							//逻辑错误
							mui.toast(data.Data);
							return;
						}
						}, function(err) {
							//hideLoading();
						})											
					}else{
						mui('#popover').popover('hide');
					}
				});
	})
//	function deleteContentItem(){		
//		var path = 'CMS/DeleteContentItem?contentItemId='+contentItemId;
//			var params = {
//				contentItemId : contentItemId
//			}
//			postDatawithToken(path,{}, function(data) {	
//				if(data.Type == 1) {
//					mui.toast("删除成功");
//					if(mui.os.plus){
//						
//					}else{
//						setTimeout(function() { mui.back(); }, 500)	
//					}
//				} else if(data.Type == 0) {
//					//登录失败
//					mui.toast("请登录后再进行操作");
//					login();
//					return;
//				} else {
//					//逻辑错误
//					mui.toast(data.Data);
//					return;
//				}
//			}, function(err) {
//			})
//	}
	var ItemName;
		function getDetail(id) {
			showLoading('', '', '#FFFFFF', '50px');
			getDatawithToken('CMS/CMSNewsDetail', {
				contentItemId: id
			}, function(data) {
				hideLoading();
				hideErr();
				if(data.Type == 1) {
					if(data.Data && typeof(data.Data) == 'object') {						
						var data = data.Data;
						ItemName = data.Subject;
						//document.getElementById('specialNews').innerHTML = data.IsSpecialCMS == false ? '<a><i class="fa fa-thumbs-up" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp推荐</a>' : '<a><i class="fa fa-thumbs-o-up" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp取消推荐</a>';
						document.getElementById('editNews').style.display = data.IsAllowMobileEdit == true ? 'block' : 'none';
						document.getElementById('DeleteNews').style.display = data.CanDelete == true ? 'block':'none';
//						if(data.IsManage == true || data.CanDelete == true || data.IsAllowMobileEdit == true ){
//							newsOpt.style.display = 'block';
//						}else{
//							newsOpt.style.display = 'none';
//						}
						setIdandType(contentItemId, 'ContentItem', data.CommentCount)
						ii = data.Comments.length;
						userAvator.src = data.Avatar == "" ? "../img/avatar.jpg" : getImgUrl(data.Avatar);
						userid = data.UserId;
						new_detail.innerHTML = '';
						new_detail.innerHTML = getBodyImgUrl(data.Body);
						wximgEl.innerHTML = getBodyImgUrl(data.Body);
						NewsName.innerHTML = data.CategoryName.substring(0, 15);
						hittimes.innerHTML = data.HitTimes;
						if(data.Tags.length > 0) {
							tagsContainer.style.display = 'block';
							tags.appendChild(createTags(data.Tags))
						} else {
							tagsContainer.style.display = 'none';
						}
						isAttitude = data.IsAttitude;
						changeSupport(data.IsAttitude);
						newsTitle.innerHTML = data.Subject;
						title = data.Subject;
						Author.innerText = data.Author.substring(0,10);
						DateCreated.innerText = data.DatePublished;
						attitudeCount.innerText = data.AttitudeCount;
						attitudeNum = data.AttitudeCount;
						if(data.Attachments && data.Attachments.length > 0) {
							attachments.style.display = 'block';
							attachments.appendChild(creatAttachment(data.Attachments));
						} else {
							attachments.style.display = 'none';
						}
						if(data.Comments && data.Comments.length==0){
							document.getElementById("noCom").style.display=''
						}else{
							document.getElementById("noCom").style.display='none'
							if(data.Comments && data.Comments.length < 5) {
								morecomment.style.display = 'none';
							} else {
								morecomment.style.display = 'block';
							}
							commentArea.appendChild(createComFragment(data.Comments));
						}
						setLastBoard();
						setShareInfo(getlsData('currUrl'), data.Subject, data.Subject, 'http://upload.cankaoxiaoxi.com/2017/0524/1495629970905.jpg?q=75');
						com.isFavorited = data.IsFavorite;
						favorThread(data.IsFavorite);
						canComment(data.IsComment);
					} else {
						showErr(data.Data, '', '#FFFFFF', '50px');
						mui.toast(data.Data);
					}
				} else if(data.Type == 0) {
					//登录失败
					mui.toast("请登录后再进行操作");
					login();
					return;
				} else {
					//逻辑错误
					showErr(data.Data, '', '#FFFFFF', '50px')
					mui.toast(data.Data);
					return;
				}
			}, function(err) {
				setErr()				
			})
		}

//		function canComment(isComment) {
//			document.getElementById("jgb").style.display = !isComment ? 'inherit' : 'none';
//			document.getElementById("commentList").style.display = !isComment ? 'inherit' : 'none';
//			document.getElementById("commentBar").style.display = !isComment ? 'table' : 'none';
//		}

		function attitudeContentItem(contentItemid) {
			postDatawithToken('CMS/AttitudeContentItem?contentItemId=' + contentItemid, {}, function(data) {
				if(data.Type == 1) {
					//mui.toast(data.Data);
					changeSupport(true);
				} else if(data.Type == 2) {
					//mui.toast(data.Data);
					changeSupport(false);
				} else if(data.Type == 0) {
					//登录失败
					mui.toast("请登录后再进行操作");
					login();
					return;
				} else {
					//逻辑错误
					mui.toast(data.Data);
					return;
				}
			}, function(data) {
				hideLoading()
			});
		}

		function changeSupport(isattitude) {
			supportArea.querySelector('a').className = isattitude ? 'active' : '';
			document.getElementById("support").parentElement.style.borderColor = isattitude ? '#bf0a10' : '#ccc';
			attitudeCount.style.color = isattitude ? '#bf0a10' : '#ccc';
			isAttitude = isattitude;
			if(isattitude) {
				attitudeNum = attitudeNum + 1;
				attitudeCount.innerText = attitudeNum;
			} else {
				attitudeNum = attitudeNum - 1;
				attitudeCount.innerText = attitudeNum;
			}
		}
		supportArea.addEventListener('tap', function() {
			attitudeContentItem(contentItemId)
		})
		mui("#attachments").on('tap', 'a', function(e) {
			if(mui.os.plus) {
				startDownloadTask(this.getAttribute('id'))
			} else {
				download(this.getAttribute('id'), this.getAttribute('title'), location.href.split('#')[0])
			}

		})
		mui("#tags").on('tap', 'span', function(e) {
			var tagname = e.target.innerText;
			var baseUrl = 'newsBytag_main.html';
			var url = mui.os.plus ? baseUrl : baseUrl + '?Tagname=' + tagname;
			mui.openWindow({
				url: url,
				id: 'newsBytag_main.html',
				show: {
					autoShow: false
				},
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				},
				extras: {
					Tagname: tagname
				}
			})
		});

		mui("#commentArea").on('tap', '.creator_img_comment', function(e) {
			var userid = this.getAttribute('id');
			var baseUrl = 'userHomepage.html';
			var url = baseUrl + '?userId=' + userid;
			mui.openWindow({
				url: url,
				id: 'userHomepage.html',
				show: {
					autoShow: false
				},
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				},
				extras: {
					userId: userid
				}
			})

		})
		var old_back = mui.back;  
		mui.back=function(){
			if(!mui.os.plus){
				if(history.length==1){
					history.replaceState(null, "", "../index.html");
					window.location.reload()
				}else{
					history.back(-1)
				}
			}else{
				old_back();
			}
		}

	
	</script>

</html>