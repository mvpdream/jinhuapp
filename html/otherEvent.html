<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--通用样式-->
		<link rel="stylesheet" / href="../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../css/icons-extra.css" />
		<link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css" />
		<!-- <link rel="stylesheet" type="text/css" href="../css/question-list.css" />      	 -->
		
		<link rel="stylesheet" / href="../css/jinhu.css">
	</head>
	<style>
		.starCon span{
			padding-right: 0px !important;
			margin-left: 0px !important;
			margin-right: 0px !important;
		}
		.text-muted-left{
			padding-left: 17px;
			padding-right: 7px;
			padding-bottom: 10px;
		}
		.document-list .mui-content-padded p{
	font-size: 16px;
	word-wrap: break-word;
	word-break:break-all;
	margin-bottom: 5px;   
}
.document-list .mui-content-padded span{
    padding-left: 3px;
    padding-right: 3px;
 	margin-left: 8px;
	border-radius: 3px; 
	font-size: 11px;
}
.document-list .mui-content-padded .label{
	font-size: 12px;
	height: 20px;
	white-space: inherit;
}
		#icon{
			display: inline-block !important;
    		font-size: 16px !important;
    		padding-left: 0px !important;
    		margin-left: 0px !important;
    		position: absolute;
			position: absolute;
		}
		.status{
			display: inline-block;
			vertical-align: top;
			padding-left: 0.7rem !important;
			margin-top: 3px;
			margin-bottom: 7px;
		}
		.status span{
			display: inline-block;
			margin-right: 0.2rem;
		}
		.status span:first-child{
			margin-left: -19px !important;
		}
		.subject{
			padding: 10px 10px 0px 15px;
    		position: relative;
    		word-break: break-all;
    		font-size: 16px;
    		line-height: 16px;
		}
		.mui-row{
			margin-left: -4px;
			margin-right: -5px;
			margin-top: -4px;
			margin-bottom: 0px;
		}
		
		.text-muted {
		    padding-left: 16px;
		    padding-right: 5px;
		    font-size: 12px;
		    padding-top: 5px;
		    padding-bottom: 10px;
		}
		.content{
			word-wrap: break-word;
			display: inline-block;
			margin-right: 0.4rem;
			margin-left: 1.2rem;
		}
		.mui-bar~.mui-content .mui-fullscreen {
			top: 44px;
			height: auto;
		}		
		.mui-pull-top-tips {
			position: absolute;
			top: -20px;
			left: 50%;
			margin-left: -25px;
			width: 40px;
			height: 40px;
			border-radius: 100%;
			z-index: 1;
		}
		
		.mui-bar~.mui-pull-top-tips {
			top: 24px;
		}		
		.mui-pull-top-wrapper {
			width: 42px;
			height: 42px;
			display: block;
			text-align: center;
			background-color: #efeff4;
			border: 1px solid #ddd;
			border-radius: 25px;
			background-clip: padding-box;
			box-shadow: 0 4px 10px #bbb;
			overflow: hidden;
		}		
		.mui-pull-top-tips.mui-transitioning {
			-webkit-transition-duration: 200ms;
			transition-duration: 200ms;
		}		
		.mui-pull-top-tips .mui-pull-loading {
			margin: 0;
		}		
		.mui-pull-top-wrapper .mui-icon,
		.mui-pull-top-wrapper .mui-spinner {
			margin-top: 7px;
		}		
		.mui-pull-top-wrapper .mui-icon.mui-reverse {
		}		
		.mui-pull-bottom-tips {
			text-align: center;
			background-color: #efeff4;
			font-size: 15px;
			line-height: 40px;
			color: #777;
		}		
		.mui-pull-top-canvas {
			overflow: hidden;
			background-color: #fafafa;
			border-radius: 40px;
			box-shadow: 0 4px 10px #bbb;
			width: 40px;
			height: 40px;
			margin: 0 auto;
		}		
		.mui-pull-top-canvas canvas {
			width: 40px;
		}		
		.mui-slider-indicator.mui-segmented-control {
			background-color: #efeff4;
		}		
		.jh-orange {
			color: #FF9900;
		}		
		.typeitem {
			text-align: center;
			border: 1px solid #BCBCBC;
			height: 35px;
			padding-top: 5px;
			padding-right: 10px;
		}						
		.jh-title {
			float: left;
		}
		.mui-scroll{
			min-height: 100%;
		}
		.document-list{
			border-bottom: 1px solid #e4e4e4;
		}
		.popover-item{
			padding:13px 15px;border-radius:0;color:#000000
		}
		.mui-bar-nav~.mui-content .mui-pull-top-pocket {
		    top: 0px;
		}
		.text-muted{
			padding-left: 0px !important;
			padding-bottom: 0px !important;
		}
		#attend{
			border-radius: 5px;
    		background-color: #dd524d;
    		color: #fff;
		}
	</style>
	<body style="background-color: #FFFFFF;">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left" style="color:#333333">
				<span class="mui-icon mui-icon-left-nav"></span><span id="navtil"></span>
			</a>
			<span class="mui-pull-right" id="creatdocument" style="display: none;">
				<i class="fa fa-plus" style="font-size: 23px;line-height: 50px;padding-right: 4px;" aria-hidden="true"></i>
			</span>
		</header>
		<div class="mui-content" id="contentArea" style="display: block">
			<div id="slider" class="mui-slider mui-fullscreen">
				<div class="mui-slider-group" id="sliderGroup">
					<div id="itemmobile" class="mui-slider-item mui-control-content mui-active">
						<div class="mui-scroll-wrapper" id="refreshContainer">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									
								</ul>
							</div>
						</div>
					</div>				
				</div>
			</div>
			<script src="../js/mui.min.js"></script>
			<script src="../js/crypto-js.js"></script>
			<script src="../js/mui.pullToRefresh.js"></script>
			<script src="../js/mui.pullToRefresh.material.js"></script>
			<script src="../js/service.js"></script>
			<script src="../js/common.js"></script>
			<script src="../js/wxHelper.js"></script>
	</body>
	<script type="text/javascript">
		var userId = 0;
		var username="";
		var creatdocument = document.getElementById("creatdocument");
		var islog = getlsData('isLogin');
		window.onload = function() { 
			//获取url中的targetId参数                                                                                                           
			if(mui.os.plus) {
				mui.plusReady(function() {
					var self = plus.webview.currentWebview();
					userId = self.userId;
					username=self.username;
					GetotherEvents(false, userId,'create')
					username=(username=="me")?"我":username
					creatdocument.style.display=(username=="我")?'block':'none';					
					document.getElementById("navtil").innerHTML=username+'的活动';
					//关闭等待框                                                                                                               
					plus.nativeUI.closeWaiting();
					//显示当前页面                                                                                                              
					mui.currentWebview.show();
				});
			} else {
				userId = getUrlParam('userId');
				username=getUrlParam('username');
				GetotherEvents(false, userId,'create')
			}
			username=(username=="me")?"我":username
			creatdocument.style.display=(username=="我")?'block':'none';
			document.getElementById("navtil").innerHTML=username+'的活动';
		}
		creatdocument.addEventListener('tap',function(){
				mui.openWindow({
					url: 'creatDoc.html',
					id: 'creatDoc.html',
					show:{
				      autoShow:false
				   },
					waiting: {
						options: {
							loading: {
								height: '35px'
							}
						}
					}
				})
			})
		var ids = [];				
		function login (){
			if(mui.os.wechat){
				getCode('',true)
			}else{
				mui.openWindow({
				url: 'user_login.html',
				id: 'user_login.html',
				waiting: {
					options: {
						loading: {
							height: '35px'
						}
					}
				}
			})	
			}			
		}
		var selel = document.getElementsByClassName("mui-control-item mui-active");
		mui('.mui-slider').slider();
		var deceleration = mui.os.ios ? 0.003 : 0.0009;
		mui('.mui-scroll-wrapper.mui-slider-indicator.mui-segmented-control').scroll({
			scrollY: false,
			scrollX: true,
			indicators: false,
			deceleration: deceleration,
			snap: '.mui-control-item'
		});
		var pageindex = 1;
	mui.init({
		pullRefresh: {
			container: '#refreshContainer',
			down: {
				callback: pulldownRefreshCom
			},
			up: {
				contentrefresh: '正在加载...',
				callback: pullupRefreshCom
			}
		}
	});                                                                                                                            
	function pulldownRefreshCom() {                                                                                                      
		setTimeout(function() { 
			GetotherEvents(false, userId,'create')                                                                                      
			mui('#refreshContainer').pullRefresh().endPulldownToRefresh();                                            
		}, 1500);                                                                                                                     
	}                                                                                                                                 
	var count = 0;                                                                                                                                                                                                                                                  
	function pullupRefreshCom() {                                                                                                        
		setTimeout(function() { 
			GetotherEvents(true, userId,'create')
			mui('#refreshContainer').pullRefresh().endPullupToRefresh((++count > 2));                                                                                                                             
		}, 1500);                                                                                                                     
	}
			mui("#slider").on('tap', '.jh-news-list', function(e) {
					var eventId = this.getAttribute('id');
					var urlId = 'eventDetail.html';
					var baseUrl = 'eventDetail.html?eventId=' + eventId;
					var curl = shareUrl + baseUrl;
					setlsData('currUrl', curl);
					mui.openWindow({
						url: baseUrl,
						id: urlId,
						show: {
							autoShow: true
						},
						waiting: {
							options: {
								loading: {
									height: '35px'
								}
							}
						},
						extras: {
							eventId: eventId,
							currId: 'otherEvent.html'
						}
					})
			})
			mui("#slider").on('tap', '#attend', function(e) {	
				e.stopPropagation();
				var eventId = e.target.title;
				var remainingEnrolment = e.target.parentElement.id;
				if(islog == 'true') {
					var baseUrl = 'eventSignUp.html?eventId=' + eventId + '&remainingEnrolment=' + remainingEnrolment+'&memberId='+0;
					mui.openWindow({
						url: baseUrl,
						id: 'eventSignUp.html',
						show: {
							autoShow: true
						},
						waiting: {
							options: {
								loading: {
									height: '35px'
								}
							}
						},
						extras: {
							eventId: eventId,
							remainingEnrolment: remainingEnrolment,
							memberId:0
						}
					})
				} else {
					login();
				}
			})
		var creatEventElement = function(data,more) {
			var finel = document.getElementById('refreshContainer').querySelector('.mui-table-view');
			var newFragment = document.createDocumentFragment();
			for(var i = 0; i < data.length; i++) {
				var remainingEnrolment = data[i].MemberCount - data[i].AttendCount;
				if(data[i].MemberCount==0){
					remainingEnrolment=9999
				}
				var CanAttend = data[i].CanAttend == true ? '<button type="button" id="attend" title="'+data[i].Id+'" class="mui-btn mui-btn-danger mui-btn-outlined">我要报名</button>' : '';
				var imgDisplay = data[i].ImageAttachment == "" ? "none" : "block";
				var addressDis = data[i].CompleteAddress == "" ? "none" : "block";
				var state = data[i].IsEnded ? '<img class="sign" src="../img/over-sign.png">' : '';
				var li;
				li = document.createElement('li');
				li.className = 'mui-table-view-cell jh-news-list';
				li.id = data[i].Id;
				li.title = data[i].VoteType;
				var memberCountText=data[i].MemberCount;
				if(memberCountText==0){
					memberCountText ='无限制'
				}
				li.innerHTML = '<div class="divImg" style="display:' + imgDisplay + '";padding: 5px 0 5px 0"><img style="display:' + imgDisplay + '" src=' + getImgUrl(data[i].ImageAttachment) + '  ></div>' +
					'<h5 class="listTitle">' + data[i].Subject + '</h5>' +
					'<ul class="mui-list-inline text-muted">' +
					'<li style="display:block;">活动时间：<span>' + data[i].StartDate + '</span>—<span>' + data[i].EndDate + '</span></li>' +
					'<li style="display:' + addressDis + ';">活动地址：' + data[i].CompleteAddress + '</li>' +										
					'</ul>' +
					'<ul class="mui-list-inline" id="'+ remainingEnrolment +'">'+
					CanAttend+
					'<li style="color:#999;font-size:12px;display:block;">已报名 <span class="tn-theme-color">' + data[i].AttendCount + '</span>/' + memberCountText + '</li>' +
					'</ul>'+
					'</li>';
				if(more == true){
					finel.appendChild(li);
				}else{
					newFragment.appendChild(li);
				}
			}
			if(more == false){
				finel.innerHTML=nodeToString(newFragment);
			}
		};
		var page = 1;
		var idName = "";
		var bool;

		function GetotherEvents(more, userId,eventType) {
//			if(!more) {
//				showLoading('', '', '#FFFFFF', '90px', '1');
//			}
			var table = document.body.querySelector('.mui-table-view');
			var fragment=document.getElementById('itemmobile');
			if(more) {
				page++;
			} else {
				//table.innerHTML = '';
				page = 1;
			}
			var params = {
				userId: userId,
				eventType:eventType,
				pageSize: 10,
				pageIndex: page,
			};
			getDatawithToken('Event/GetUserEvents', params, function(data) {
				hideLoading()
				if(data.Type == 1) {
					console.log(data)
					if(data.Data && typeof(data.Data) == 'object') {
						if(data.Data.length == 0) {
							if(!more) {
								var errForList = showErrForList('暂无活动', '', '','itemmobile');
								if(errForList) {
									fragment.appendChild(showErrForList('暂无活动', '', '','itemmobile'))
								}
							}
						}
							creatEventElement(data.Data,more);
					} else {
						table.querySelector('.mui-loading').style.display = 'none';
						if(!more) {
							var errForList = showErrForList('暂无活动', '', '','itemmobile');
							if(errForList) {
								fragment.appendChild(showErrForList('暂无活动', '', '','itemmobile'))
							}
						}
						document.getElementById('itemmobile').querySelector('.mui-pull-bottom-tips').style.display = 'none';
						mui.toast(data.Data);
					}
				} else if(data.Type == 0) {
					//登录失败
					mui.toast("请登录后再进行操作");
					login();
					return;
				} else {
					//逻辑错误
					var errForList = showErrForList(data.Data, '', '', idName);
					if(errForList) {
						fragment.appendChild(showErrForList(data.Data, '', '', idName))
					}
					mui.toast(data.Data);
					return;
				}
			}, function(err) {
				setErr('','90px')
			})
		}
		mui.init({
			gestureConfig: {
				swipeBack: true //启用右滑关闭功能
			},
		});								
	</script>
</html>